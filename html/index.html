<!DOCTYPE html>
<title>DISPLAY 4.0</title>
<meta name="description" content="Interactive visualisation Display Data.">
<meta name="author" content="e-Coucou">
<html class="rky">
<meta charset="utf-8">
<title>Display 4.0</title>
<style>
@import url(../css/dsp.css);

#chart {
	position : relative;
}
.entete {
    position: absolute;
    height: 30px;
    margin-top: 12px;
}
text {
  font: 10px sans-serif;
}

.label {
    fill: #777;
}
.infoG.label {
    font: 12px "helvetica neue";
    fill: #191970;
}

#intervalle {
    position: absolute;
    top: 15px;
    right: 30px;
}
#info {
    position: absolute;
    bottom: 5px;
    right: 20px;
}
#menu {
    position: absolute;
    top: 0px;
    right: 20px;
}
#titre {
    position: absolute;
    top: 14px;
    left: 0px;
	font-weight: bold;
	text-anchor: middle;
    font: 24px "helvetica neue";
}
.axis,
.frame {
  shape-rendering: crispEdges;
}

.axis line {
  stroke: #ddd;
}

.axis path {
  display: none;
}

.cell text {
  font-weight: bold;
  text-transform: capitalize;
}

.frame {
  fill: none;
  stroke: #aaa;
}
circle {
  fill-opacity: .7;
}

circle.hidden {
  fill: #ccc !important ;
}

.extent {
  fill: #000;
  fill-opacity: .125;
  stroke: #fff;
}
input#username,
input#password,
input#connexion { 
    border: 1px dotted #ccc;
    background: white;
    font-family: monospace;
    padding: 2% 2%;
    font-size: 18px;
    margin: 2% 2% 2% 5%;
    width : 85%;
    height: 40%;
    color: red;
}
input:focus { 
    background-color:#0cf; color: red; outline: none;
}
div#label {
    position:absolute;
    display: block;
    font-size: 12px;
    top:0;
    padding: 5px 0px;
    margin: 10px 0px 0px 50px;
}
input#from,
input#to {
    color: blue;
    font: 12px "helvetica neue";
}
#credentials {
  left: 30%;
  top: 100px;
  margin: 10px;
  padding: 10px;
  width: 40%;
  position: absolute;
  border: 3px solid #ff7788;
}
#loadjson {
    left: 30%;
    top: 350px;
    position: absolute;
    font-family: monospace;
    font-size: 14px;
}
</style>
<header>
  <div id='h1'>Display 4.0</div>
  <aside >Mai, 2019<br><br> | v 3.05</aside>
  <div id='menu'></div>
</header>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>
<!--	<script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script> -->
	<script src="https://unpkg.com/d3@5.7.0/dist/d3.min.js" charset="utf-8"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.js" charset="utf-8"></script>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numjs/0.16.0/numjs.js"></script>
    <script type="text/javascript" src="../js/eCtools.js"></script>
    <script type="text/javascript" src="../js/arbre.js"></script>
	<script defer src="../js/all.js"></script>
<!--	<link href="../font/all.css" rel="stylesheet"> --> <!--load all styles -->
    <div id="label" class="label">début : <input type="date" id="from" name="trip-from" value="2019-04-10"><br>
    fin : <input type="date" id="to" name="trip-from" value="2019-04-23"></div>
    <div id='titre'></div><div id="intervalle"></div>
<!--    <button id="connectbutton" onclick="start()">Read Data</button>  -->
    <div id="credentials">
    <form name="saisie" onSubmit="return credClick()">
        <input type="text" id="username"><br>
        <input type="text" id="password">
<!--        <input name="Submit"  type="submit" id="connexion" value="Connexion" > -->
    </form></div>
    <form id="loadjson" method="post" enctype="multipart/form-data">
    <div>
        <label for="profile_pic">Sélectionnez le fichier à utiliser :</label><br><br>
        <input type="file" id="refJson" name="refJson" accept=".json"><br><br>
        Le format du fichier<br>[{nom:'variable_1',select:0/1/2/3},<br>{nom:'variable_2',select:2},<br>{...},{}]<br>
        select : 0(non affiché), 1(cumulé), 2(variable simple), 3(quotient)
    </div>
    </form>
    <div id="chart"></div>
<footer>
<aside>(c) e-Coucou | y2kJ | Mars, 2019</aside>
    <div id="info"></div>
</footer>
    <script type="text/javascript">
// Variables Globales
    var timeStart=0,timeStop=0;
    var config = {credOK: false, tagOK:false, dataOK:false, arcOK:false, arbreOK: false};
	var from_to = [];
    var matWid=true;
	var AllData=[],CumulData=[], DivData=[],NormData=[],Tags=[];
	var indexCumul=0, indexQuotient=0; indexRef = 0;
	var username = "Username"
	var password = "Password"
    var code = ""; //prompt("Token : "); //"";
	var refListe = '', refDiviseur='', refCumul='', refAll = ''; // refAll => version 2 et+
	var interval = 'P1D'
    var urlData = 'https://cors-rky.herokuapp.com/https://oianalytics-100.optimistik.fr/api/optimistik/data';
//    var urlBase = 'http://192.168.1.33:8080/https://oianalytics-100.optimistik.fr/api/optimistik/data/time_values?dataReferenceList=';
    var urlBase = 'https://cors-rky.herokuapp.com/https://oianalytics-100.optimistik.fr/api/optimistik/data/time_values?dataReferenceList=';
//    var urlData = 'https://cors-anywhere.herokuapp.com/https://oianalytics-100.optimistik.fr/api/optimistik/data';
//    var urlBase = 'https://cors-anywhere.herokuapp.com/https://oianalytics-100.optimistik.fr/api/optimistik/data/time_values?dataReferenceList=';
//    var urlData = 'https://oianalytics-100.optimistik.fr/api/optimistik/data';
//    var urlBase = 'https://oianalytics-100.optimistik.fr/api/optimistik/data/time_values?dataReferenceList=';
//    var urlBase ='http://corsproxy.nodester.com/?src=oianalytics-100.optimistik.fr/api/optimistik/data/time_values?dataReferenceList=';
	var urlBaseOld = 'https://oianalytics-100.optimistik.fr/api/optimistik/data/time_values?dataReferenceList=';
    var urlTime = '';
    var urlRes = '&resolution='+interval;
    var url = '';
    var indexCouleur = [],frequence=[];
	var QUS_EP = 'RON_QUS_Soude_HCN,RON_QUS_Ammoniaque_HCN,RON_QUS_Azote_HCN,RON_QUS_Azote_HCN,RON_QUS_Gaz_Ferme_HCN,RON_QUS_Gaz_Procédé_HCN,RON_QUS_Vapeur_HCN,RON_QUS_ED_HCN,RON_QUS_Air_HCN,RON_QUS_Vapeur_Produite_HCN';
	var PUS_EP = 'RON_PUS_Soude_HCN,RON_PUS_Ammoniaque_HCN,RON_PUS_Ammoniaque_HCN,RON_PUS_Azote_HCN,RON_PUS_Gaz_Ferme_HCN,RON_PUS_Gaz_Procédé_HCN,RON_PUS_Vapeur_HCN,RON_PUS_ED_HCN,RON_PUS_Air_HCN,RON_PUS_Vapeur_Produite_HCN';
    let listeVal = [{nom:'RON_Masse_HCN_Estimation_MMP_Théorique',select:3},
            {nom:'RON_Cout_Revient_Ammoniaque_HCN_Convertisseurs',select:1},
            {nom:'RON_Cout_Revient_Soude_HCN',select:1},
            {nom:'RON_Cout_Revient_Gaz_Procédé_HCN',select:1},
            {nom:'RON_Cout_Revient_Gaz_Ferme_HCN',select:1},
            {nom:'RON_Cout_Revient_Vapeur_HCN',select:1},
            {nom:'RON_Cout_Revient_ED_HCN',select:1},
            {nom:'RON_Cout_Revient_Azote_HCN',select:1},
            {nom:'RON_Cout_Revient_Air_HCN',select:1},
            {nom:'RON_Rendement_GN_HCN_Convertisseurs_MMP',select:0},
            {nom:'RON_Rendement_GN_HCN_K82300',select:0},
            {nom:'RON_Rendement_GN_HCN_K82700',select:0},
            {nom:'RON_Rendement_NH3_HCN_Convertisseurs_MMP',select:0},
            {nom:'RON_Rendement_NH3_HCN_K82300',select:0},
            {nom:'RON_Rendement_NH3_HCN_K82700',select:0},
            {nom:'RON_QUR_Soude_HCN',select:0},{nom:'RON_QUR_Ammoniaque_HCN_Evapo',select:0},{nom:'RON_QUR_Ammoniaque_HCN_Convertisseurs',select:0},{nom:'RON_QUR_Azote_HCN',select:0},{nom:'RON_QUR_Gaz_Ferme_HCN',select:0},{nom:'RON_QUR_Gaz_Procédé_HCN',select:0},{nom:'RON_QUR_Vapeur_HCN',select:0},{nom:'RON_QUR_ED_HCN',select:0},{nom:'RON_QUR_Air_HCN',select:0},
			{nom:'RON_Ratio_Air_GN_K82300_Indication',select:2},
			{nom:'RON_Ratio_Air_GN_K82700_Indication',select:0},
			{nom:'RON_Ratio_Air_NH3_K82300_Indication',select:2},
			{nom:'RON_Ratio_Air_NH3_K82700_Indication',select:0},
			{nom:'N-PS82331',select:0},
			{nom:'N-PXS82363',select:2},
			{nom:'N-PS82731',select:0},
			{nom:'N-PXS82763',select:0},
			{nom:'N-F82102',select:2},
			{nom:'N-F82502',select:2},
			{nom:'5A-CH4-GAZ',select:2},
			{nom:'N-TYS82302',select:0},
			{nom:'N-TYS82303',select:0},
			{nom:'N-TYS82304',select:2},
			{nom:'N-US82311',select:0},
			{nom:'N-TS82301',select:0},
			{nom:'N-T82305-1',select:0},
			{nom:'N-TC82308',select:0},
			{nom:'N-TYS82702',select:0},
			{nom:'N-TYS82703',select:0},
			{nom:'N-TYS82704',select:2},
			{nom:'N-US82711',select:0},
			{nom:'N-TS82701',select:0},
			{nom:'N-TCS82705',select:0},
			{nom:'N-TC82708',select:0}
			];
    var listeDashboard = [];
    var unSelect = [],brushListe=[];
	var corVal;
	var dispatch = d3.dispatch('load','change','partial','dashboard','update');
    let icon = ['eye-slash','plus','eye','code'];
	// Chart dimensions.
var margin = {top: 20, right: 20, bottom: 30, left: 50},
    width = window.innerWidth - margin.right-margin.left,
    height = 550 - margin.top - margin.bottom;
var couleur = ['grey','green','violet','cyan','blue','orange','yellow','red'];
// Create the SVG container and set the origin.
var svg = d3.select("#chart").style('top','57px')
    .append("svg")
	.attr('class','svg-contenair')
//	.attr("preserveAspectRatio", "xMinYMin meet")
	.attr("viewBox", "0 0 "+(width + margin.left + margin.right)+" "+(height + margin.top + margin.bottom))
    .attr("position", 2)
	.classed("svg-content", true);
 
 const div = d3.select("body").append("div")
    .attr("class", "tooltip")         
    .style("opacity", 0);
 
//--------
    var arbreG = svg.append('g').attr('id','arbre');
    var seed = {i: 0, x: 35, y:(height +margin.top+margin.bottom), a: 0, l: 13, d:1}; // a = angle, l = length, d = depth {i: 0, x: 420, y: 600, a: 0, l: 130, d:0};
    var arbre = new Arbre(arbreG,seed);
    if (config.arbreOK)  arbre.regenerate(true);

// Menu Graphique 
let selGraphe=-1, selCourbe=0; //credentials

// Menu Intervalle
//xx ajouter le calcul sur 8h, 7 jour et 1 mois
let selInter=-1;
const intWidth = 150;
var svgInt = d3.select("#intervalle").append("svg")
    .attr('width',intWidth).attr('height',22)
    .attr("position", 1)
    .append("g").raise();
var IntervalData= [{v:'P1M',t:'m',e:720},{v:'P7D',t:'s', e:168},{v:'P1D',t:'j',e:24},{v:'PT8H',t:'p',e:8}]; // e=elapse en h à convertir en ms
var interG = svgInt.selectAll('g').data(IntervalData).enter()
	.append('g')
	.attr('transform',function (d,i){ return ('translate('+ (intWidth-20-i*25)+','+11+')');})
    .on('click',click);
		
	interG.append('circle').attr('fill','#2E2D88')
        .attr('r',10)
		.on('mouseover',function(d,i){ d3.select(this).attr('fill','#FE6F5E');})
        .on('mouseout',function(d,i){ d3.select(this).attr('fill',(a)=>{return (i==selInter)?'red':'#2E2D88';});});
 //.attr('cx',(d,i)=>{return width-i*25;}).attr('cy',15)
	interG.append('text').attr('fill','white').style('text-anchor','middle')
        .attr('dy','0.3em').text(d=>d.t).raise();
// Menu Titre
var menuTitre=[{id:1,n:'<',s:0.5,d:0},{id:2,n:'-',s:9,d:0.5},{id:3,n:'>',s:0.5,d:9.5}];
var sizeTitre = (width/2/10)-1;
d3.select('#titre').style('left',(width/4+margin.left)+'px');
var svgTitre = d3.select("#titre").append("svg")
    .attr('width',width/2).attr('height',40).append("g").raise();

function aff_Titre() {
var titreG = svgTitre.selectAll('g').data(menuTitre);
	titreG.enter()
		.append('g').attr('class','titre')
		.attr('transform',function (d,i){ return ('translate('+ (d.d*sizeTitre)+','+2+')');})
		.on('click',clickTitre);
titreG.selectAll('rect').remove();
titreG.selectAll('text').remove();
var	titreRect = titreG.append('rect').attr('height',32).attr('width',d=>(d.s*(sizeTitre)-2)).style('fill','#FE6F5E')
        .on('mouseover',function(d) {d3.select(this).style('fill','red');})
        .on('mouseout',function(d) {d3.select(this).style('fill','#FE6F5E');});
var	titreTexte = titreG.append('text')
		.attr('dx',d=>(d.s*(sizeTitre)/2)).attr('dy','1.5em').style('fill','white')
		.style('font-size','1.2em')
		.text(d=>d.n);
}
function clickTitre(d) {
    //	console.log(d);
	switch (d.id) {
		case 1:
			selCourbe = (selCourbe==0 ? (AllData.length-1):(selCourbe-1) ) ; 
			break;
		case 3:
			selCourbe = (selCourbe +1 ) % AllData.length; 
			break;
	}
    clearSVG();
	graphe(selCourbe);
}
	aff_Titre();
	
// Information data
var svgInfo = d3.select("#info").append("svg")
    .attr('width',width/2).attr('height',20);
var infoG = svgInfo.append('g')
        .attr('transform','translate(0,15)');
        
    infoG.append('circle').attr('fill','white')
        .attr('r',5).attr('cx',width/2-10)
        .on('click',clickInfo);
    infoG.append('text').attr('fill','white').style('text-anchor','end')
        .attr('dx',width/2-25).attr('dy','0.3em')
        .text('informations').raise();
function clickInfo() {
    config.arbreOK = !config.arbreOK;
    if (config.arbreOK) {
        arbre.regenerate(true);
    }else{
        d3.select('#arbre').remove();
    }
}
// Menu Header
var data_menu = [
        { n:0, x:-240, m:'chart-bar', a:'Bargraphe'},
        { n:1, x:-240, m:'th', a:'Mattrix'},
        { n:2, x:-240, m:'chart-line', a:'Courbe'},
        { n:3, x:-240, m:'cogs', a:'Parametre'},
        { n:4, x:-240, m:'filter', a:'Selection'},
        { n:5, x:-240, m:'diagnoses', a:'Dashboard'},
        { n:-1, x:-240, m:'user-secret', a:'credential'}
    ];
var svgMenu = d3.select("#menu").append("svg")
    .attr('width',45*data_menu.length).attr('height',40);
var menuG = svgMenu.selectAll('g').data(data_menu).enter()
        .append('g')
        .attr('transform',(d,i)=>{return 'translate('+(i*40+20)+',10)';})
        .on('click',clickMenu);
var menuCircle=false;
    menuG.append('rect').style('fill',(d,i)=>(d.n==selGraphe)?'#9C143C':'red').attr('id','menuRect')
        .attr('r',17).attr('width',38).attr('height',39).attr('x',-8).attr('y',-9)
        .on('mouseover',function(d) {d3.select(this).style('fill','#FE8F7E')})
        .on('mouseout',function(d){d3.select(this).style('fill',(d,i)=>(d.n==selGraphe)?'#9C143C':'red')});
    if (menuCircle) {
        menuG.append('circle').style('fill',(d,i)=>(d.n==selGraphe)?'red':'#FE6FcE')
            .attr('r',17).attr('cx',(d,i)=>{return 10;}).attr('cy',10);
    }

    menuG.append('svg').attr('width',20)
    .attr('height',20)
    .attr('class',(d)=>{return ('icon fas fa-'+d.m);}).style('color','white');

function clickMenu(d,i) {
    doGraphe(d.n);
    selGraphique();
}
//    d3.select("#value_select").on("change", Dashboard);
    d3.select("#from").on("change", updateDate);
    d3.select("#to").on("change", updateDate);

  toDate = function (d) { return new Date(d).toLocaleDateString("fr-FR");};
	//	var t = new Date(AllData[1].values[1].timestamp).toLocaleTimeString("fr-FR") 
  var tip = d3.tip()
	.attr('class', 'd3-tip')
	.offset([-40, 0])
	.html(function(d,i,o) {
        let ref=AllData[indexRef].values.find(a=>{ return (a.timestamp==d.timestamp)?a:'';}).value;
		return "<strong>Valeur :</strong> <span style='color:yellow'>" + valFormat(d.value) + "</span><br>"+toDate(d.timestamp)+"</span><br><span style='color:white'>"+ valFormat(ref)+"</span>"; })

	let graph=svg.append('g').attr('id','graphe')
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    updateListe();
    selGraphique();
    dispatch.on('load',selGraphique);
    dispatch.on('partial',assData);
    dispatch.on('dashboard',Dashboard);
    dispatch.on('update',updateDashboard);
//
//---
//
// END 
//
//----------------------------------------------------------------------------------------------------------
// FONCTIONS ----
//	
function click(d,i) {
//    console.log(d,i);
    selInter=i;
    interG.selectAll('circle').attr('fill','#2E2D88');
    urlRes = '&resolution='+d.v;
    updateDate();
    url = urlBase+refListe +urlTime+urlRes;
//    console.log('avant: ',url);
//xxx    start(url,0); //0-variable 1-cumul 2-diviseur
	url = urlBase+refAll+urlTime+urlRes;
    if (config.credOK) {
//xxx	getAllData(url);
      for(let i=-1;++i<(from_to.length-1);) {
          urlTime = '&from='+encodeURIComponent(new Date(from_to[i]).toISOString())+'&to='+encodeURIComponent(new Date(from_to[i+1]).toISOString());
          url = urlBase+refAll+urlTime+urlRes;
//          console.log(urlTime);
          getSpiltData(url,i);
      }
    }
}
//-----------------------------------------------------------
//-  BAR CHART STANDARD
//-----
//
function doGraphe(v) {
    selGraphe=v;
    if (menuCircle) {
        menuG.selectAll('circle').style('fill',(d,i)=>(d.n==selGraphe)?'#9C143C':'red');
    } else {
        menuG.selectAll('rect').style('fill',(d,i)=>(d.n==selGraphe)?'#9C143C':'red');
    }
}
//--------
function graphe(v=0) {
	doGraphe(0);
	selCourbe=v;
	
	menuTitre[1].n=AllData[v].dataReference;
	aff_Titre();

	// on ajuste le viewbox
    svg.attr("viewBox", "0 0 "+(width + margin.left + margin.right)+" "+(height + margin.top + margin.bottom))
    //----------------------------------------------
    //---- Gestion de la palette de couleurs 
    //
        svg.append('g').selectAll('circle').data(couleur).enter()
            .append('circle')
            .attr('cx',(d,i)=>{return i*14+margin.left+(width-14*8);})
            .attr('cy',0).attr('r',5).style('fill',(d)=>{return d;})
            .on('click',clickCouleur);
    function clickCouleur() {
        config.arcOK = !config.arcOK;
        clearSVG();
        graphe(selCourbe);
    }
    //----------------------------------------------
    //---- Filtrage des valeurs ... 
    //epxxx
	var filtreData = [{n:0,nom:'F'},{n:1,nom:'R'}];
    let fg = svg.append('g').attr('id','filtre');
	let filtreG = fg.selectAll('g').data(filtreData).enter()
        .append('g').attr('transform','translate(0,0)');
	console.log(filtreData);
	filtreG.append('circle').attr('cx',(d,i)=>{return margin.left+30*i;}).attr('cy',17).style('fill','blue').attr('r',13)
		.on('mouseover',function(d){ d3.select(this).style('fill','red');})
		.on('mouseout',function(d){ d3.select(this).style('fill','blue');})
		.on('click',filtreAuto);

/*		svg.append('g')
		.append('circle').attr('cx',margin.left+50).attr('cy',17).style('fill','blue').attr('r',15)
		.on('mouseover',function(d){ d3.select(this).style('fill','red');})
		.on('mouseout',function(d){ d3.select(this).style('fill','blue');})
		.on('click',filtreReset);
*/	function filtreReset() {
		unSelect = [];
		dataCompute();
	}
	function filtreAuto(d,i) {
		//console.log(AllData[v]);
	  switch(d.n) {
		case 0:
		  let idx = listeVal.findIndex(d=>d.nom==AllData[v].dataReference);
		//console.log(idx,listeVal[idx]);
		  let sH = listeVal[idx].moyenne+listeVal[idx].stDev;
		  let sL = listeVal[idx].moyenne-listeVal[idx].stDev;
          AllData[v].values.forEach((v)=>{
			if (v.value>sH ||v.value<sL) {
				if (unSelect.find((a)=>{return v.timestamp===a;}) == undefined)  { unSelect.push(v.timestamp);	}
			}
		  });
		  dataCompute();
		  break;
		case 1:
		  unSelect = [];
		  dataCompute();
		  break;
	  }
	}
	//--------------------	

    seed.y = height+margin.top+margin.bottom;
    if (config.arbreOK)  arbre.regenerate(false);
    var x = d3.scaleBand()
        .domain(AllData[v].values.map(d => toDate(d.timestamp)))
        .range([margin.left, width - margin.right])
        .padding(0.1);
    yMax = Math.max.apply(Math, AllData[v].values.map(function(o) { 
             return (unSelect.find(a=>{return o.timestamp==a;}) == undefined)? o.value:-Infinity; }));
    yMin = Math.min.apply(Math, AllData[v].values.map(function(o) { 
             return (unSelect.find(a=>{return o.timestamp==a;}) == undefined)? o.value:Infinity; }));
    yMaxR = Math.max.apply(Math, AllData[indexRef].values.map(function(o) { 
             return (unSelect.find(a=>{return o.timestamp==a;}) == undefined)? o.value:-Infinity; }));
    yMinR = Math.min.apply(Math, AllData[indexRef].values.map(function(o) { 
             return (unSelect.find(a=>{return o.timestamp==a;}) == undefined)? o.value:Infinity; }));

//	console.log(yMin,yMax);
    var y = d3.scaleLinear()
        .domain([yMin, yMax]).nice()
        .range([height - margin.bottom, margin.top]);
    var z = d3.scaleLinear()
        .domain([yMinR, yMaxR]).nice()
        .range([height - margin.bottom, margin.top]);

    let yAxis = d3.axisLeft(y),
        zAxis = d3.axisRight(z);

	graph.call(tip);

//ep Zoomed ?
    var zoom = d3.zoom()
      .on("zoom", zoomed);

    svg.call(zoom);

    var y_axis = graph.append('g')
//        .attr('class', 'grid')
        .attr('transform', `translate(` +(margin.left)+`,0)`)
        .call(yAxis);

    var z_axis = graph.append('g')
        .attr('transform', `translate(` +(width-margin.right)+`,0)`)
        .call(zAxis);

    var x_axis = graph.append('g')
        .attr('transform', `translate(0,` +(height-margin.bottom)+`)`)
        .call(d3.axisBottom(x))
		.selectAll("text")	
			.style("text-anchor", "end")
			.attr("dx", "-.8em")
			.attr("dy", ".15em")
			.attr("transform", "rotate(-65)");

    graph.append('g').append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 52).attr('x',-18)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .text('unité : '+AllData[v].unit);
	
//	console.log(AllData[v].values);
	var dta = AllData[v].values,
        dtb = AllData[indexRef].values;
    var	bar = graph.selectAll()
            .data(dta).enter()
            .append("g");
	
//    console.log(y.domain()[0],y.domain()[1]);
//    AllData.each(d=> {d.values.each(a=>{console.log(a.value);})});
    var bRect = bar.append("rect")
//      .style("fill", "steelblue")
      .attr('opacity', 1).style("fill", 
        (d,i)=> { //console.log(d, unSelect);
            return (unSelect.find(a=>{return d.timestamp==a;}) == undefined)?
                ((brushListe.find(b=>{return d.timestamp==b;}) == undefined)?
                 config.arcOK?indexCouleur[i]:"steelblue"
                :"red"):"black";})
      .attr("x", d =>  x(toDate(d.timestamp)))
      .attr("y", d => d.value<0?y(y.domain()[1]):y(d.value)) 
      .attr("height", d =>{ return (d.value<0)?(y(d.value)-y(y.domain()[1])):(Math.abs( y(y.domain()[0]) - y(d.value)));})
      .attr("width", x.bandwidth())
        .on("mouseover", function(d,i,n) {
			tip.show(d,n[i]);
        })
        .on("mouseout", function(d) {
            div.style("opacity", 0).style("fill", "steelblue");
			tip.hide(d,this);
        })
        .on("mouseenter", function (d,i) {
            d3.selectAll('.value')
                .attr('opacity', 0)
            const h = d.value<0?(y(d.value)):y(d.value);
            d3.select(this)
                .attr('opacity', 0.9).style('fill','#FE6F5E')
                .attr('width', x.bandwidth() );
            bar.append('line')
                .attr('id','limit')
                .attr('x1', 0)
                .attr('y1', h)
                .attr('x2', width)
                .attr('y2', h)
                .attr('stroke', '#75f');
            bar.append('text')
                .attr('class','difference')
                .attr('x', (d) => x(toDate(d.timestamp)) + x.bandwidth() / 2)
                .attr('y', (d) => (d.value<0?(y(d.value)-25):(25+y(d.value))))
                .attr('text-anchor', 'middle')
                .text((a,k)=>{
                    const v=a.value-d.value;
                    return (k===i)?'':(Math.round(v/d.value*100.0) + ' %');})
            bar.select('.value').attr('opacity',(a,k)=> { return (k===i ? 1:0);});
        })
        .on('mouseleave', function (d,i) {
            bar.select("#limit").remove();
            bar.select(".difference").remove();
            bar.select('.value').attr('opacity',1);
            d3.select(this)
                .attr('opacity', 1).style("fill", 
                    (d)=> {// console.log(d, i,j);
                    return (unSelect.find(a=>{return d.timestamp==a;}) == undefined)? 
                        ((brushListe.find(b=>{return d.timestamp==b;}) == undefined)?
                 config.arcOK?indexCouleur[i]:"steelblue"
                        :"red"):"black";})
                .attr('width', x.bandwidth());
        })
        .on('click',function (d,i) {
            if (unSelect.find((a)=>{return d.timestamp===a;}) == undefined)  {
                unSelect.push(d.timestamp);
            }else{
                unSelect = unSelect.filter((a)=>{return d.timestamp!==a;});
            }
			dataCompute();
          }
        );
    var bText = bar.append('text')
          .attr('class', 'value')
          .attr('opacity',1)
          .attr('x', (d) => x(toDate(d.timestamp)) + x.bandwidth() / 2)
          .attr('y', (d) =>  (d.value<0?(y(d.value)-25):(25+y(d.value))))
          .attr('fill', 'white')
          .attr('text-anchor', 'middle')
          .text(d=>{return valFormat(d.value);});	

    var line = d3.line()
            .x( //d=>{ return (unSelect.find((a)=>{return d.timestamp===a;}) == undefined)?x(toDate(d.timestamp)):'';})
               d => { return x(toDate(d.timestamp)) + x.bandwidth() / 2;})
//            .y( d => z(d.value))
            .y( d=>{ return (unSelect.find((a)=>{return d.timestamp===a;}) == undefined)?z(d.value):z(yMinR);})
            .curve(d3.curveLinear);

    d3.select('#seconde').remove();

    graph.append("path")
        .datum(dtb)
            .attr('id','seconde')
            .style("fill","none")
            .style("stroke","#8B0000")
            .style("stroke-width","2px")
            .attr("d", line );
 

function zoomed() {
    if (selGraphe==0) {
//      var new_x_scale = d3.event.transform.rescaleX(x);
      var nyScale = d3.event.transform.rescaleY(y);
      var nzScale = d3.event.transform.rescaleY(z);
/*
      x_axis.transition()
        .duration(0)
        .call(xAxis.scale(new_x_scale));
*/
    y_axis.transition()
        .duration(0)
        .call(yAxis.scale(nyScale));

    bRect.attr("y", d => d.value<0?nyScale(y.domain()[1]):nyScale(d.value)) 
        .attr("height", d =>{ return (d.value<0)?(nyScale(d.value)-nyScale(nyScale.domain()[1])):(Math.abs( nyScale(nyScale.domain()[0]) - nyScale(d.value)));});

    bText.attr('y', (d) =>  (d.value<0?(nyScale(d.value)-25):(25+nyScale(d.value))))

    z_axis.transition()
        .duration(0)
        .call(zAxis.scale(nzScale));

    line.y( d=>{ return (unSelect.find((a)=>{return d.timestamp===a;}) == undefined)?nzScale(d.value):nzScale(yMinR);})
        .curve(d3.curveLinear);
    d3.select('#seconde').remove();
    graph.append("path")
        .datum(dtb)
            .attr('id','seconde')
            .style("fill","none")
            .style("stroke","#8B0000")
            .style("stroke-width","2px")
            .attr("d", line );

/*
      circles
        .attr("cx", function(d) {
          return new_x_scale(d.x)
        })
        .attr("cy", function(d) {
          return new_y_scale(d.y)
        });
*/}
}
    } //end graphe

//--
function updateDate() {
    let from = new Date(d3.select("#from").property('value'));
    let to = new Date(d3.select("#to").property('value'));
    let t = new Date(from);
    urlTime = '&from='+encodeURIComponent(from.toISOString())+'&to='+encodeURIComponent(to.toISOString());
//        console.log(urlTime);
	from_to=[];
    if (selInter != -1) {
    //	console.log('interval ',selInter,IntervalData[selInter]);
		for (let i=from.getTime();i<=to.getTime();i+=IntervalData[selInter].e*60*60*1000) { from_to.push(i);}
            //console.log(from_to);
    }
}
//--------------------------------------------------------------------------------------
// -- Get Data from Optimistik -//// OLD VERSION ////
//
	function start(urldata,cumul=0) {   //0-variable 1-cumul 2-diviseur 3//all ?
		console.log('Read DATA ...');
//        console.log(refListe);
//        console.log(url);
        switch (cumul) {
		case 2:
            infoG.select('text').text("Cacul du diviseur ...");
            infoG.select('circle').attr('fill','violet');
			break;
		case 1:
            infoG.select('text').text("Lectures et calcul des cumuls ...");
            infoG.select('circle').attr('fill','cyan');
			break;
        case 0:
    		infoG.select('text').text("Lectures des données en cours ...");
            infoG.select('circle').attr('fill','red');
			break;
        }
		var opt = fetch(urldata, {method: 'GET',headers: new Headers({'Access-Control-Allow-Origin':'*','Accept':'application/json',
		'mode':'no-cors','credentials':'includes','Authorization':'basic '+code})}).then(response => {
		return response.json();
		})
		.then(data => {
		// JSON Data
			console.log(data);
			listeVal.forEach( (a,i) => {
				let o = data.find( f => { return (f.dataReference == a.nom);});
				if (o != undefined) {
					listeVal[i]['unit']= o.unit;
					listeVal[i]['values']= o.values;
				}
			});
		    infoG.select('text').text("Données disponibles !");
            infoG.select('circle').attr('fill','#03C03C');
            config.dataOK=true;
			switch(cumul) {
            case 2:
				DivData = data.slice();
				divCompute();
                dataCompute(); //couleurCompute();
				selGraphe=0;
				dispatch.call('load');
//				selGraphique();
				break;
            case 1:
                CumulData = data.slice();
                cumulCompute();
                let url3 = urlBase+refDiviseur+urlTime+urlRes;
				if (refDiviseur !='') { start(url3,2);    //0-variable 1-cumul 2-diviseur
				} else { 
                    dataCompute(); //couleurCompute();
					selGraphe=0;
					dispatch.call('load');
//	                selGraphique();
				}
				break;
            case 0:
                AllData = data.slice();
                let url2 = urlBase+refCumul+urlTime+urlRes;
//                console.log(' ... data de Cumul!');
                start(url2,1);    //0-variable 1-cumul 2-diviseur
				break;
			}
		})
		.catch(err => {
		// Do something for an error here
            infoG.select('text').text("ERREUR : "+err);
            infoG.select('circle').attr('fill','black');
            config.dataOK=false;
			console.log(err);
		})
	}
//----------------------------------------
// Nouvelle fonction de récupération des données en une seule requête !
function getAllData(urldata) {
	console.log('all tag : ', refAll);
	infoG.select('text').text("Lectures des données en cours ...");
	infoG.select('circle').attr('fill','red');
    var opt = fetch(urldata, {method: 'GET',headers: new Headers({'Access-Control-Allow-Origin':'*','Accept':'application/json',
        'mode':'no-cors','credentials':'includes','Authorization':'basic '+code})}).then(response => {
        return response.json();
        })
    .then(data => {
        // JSON Data
            console.log(data);
			CumulData=[],DivData=[],AllData=[];
			listeVal.forEach( (a,i) => {
				let o = data.find( f => { return (f.dataReference == a.nom);});
				if (o != undefined) {
					listeVal[i]['unit']= o.unit;
					listeVal[i]['values']= o.values;
				}
			});
		    infoG.select('text').text("Données disponibles !");
            infoG.select('circle').attr('fill','#03C03C');
            config.dataOK=true;
			// on reparti les data
			data.forEach(a=>{
				let f=listeVal.filter(b=>b.nom==a.dataReference);//	console.log('data',f);
				switch (f[0].select) {
					case 1 : CumulData.push(a);break;
					case 2 : AllData.push(a);break;
					case 3 : DivData.push(a);break;
				}
			});
//			console.log('AllData',AllData);	console.log('CumulData',CumulData);	console.log('DivData',DivData);
            cumulCompute();
			if (DivData.length >0) divCompute();
			dataCompute();
			selGraphe=0;
			selCourbe=indexRef;
			dispatch.call('load');
        })
    .catch(err => {
        infoG.select('text').text("ERREUR : "+err);
        infoG.select('circle').attr('fill','black');
        config.dataOK=false;
      console.log(err);
    })   
}
//----------------------------------------------------------------------------------------
//- lecture du dashboard ...
//----------------------------------------
var dashData=[];
function getDashData(urldata,index) {
    var opt = fetch(urldata, {method: 'GET',headers: new Headers({'Access-Control-Allow-Origin':'*','Accept':'application/json',
        'mode':'no-cors','credentials':'includes','Authorization':'basic '+code})}).then(response => {
        return response.json();
        })
    .then(data => { 
            dashData[index]=data;
            dispatch.call('dashboard');
        })
    .catch(err => {
        infoG.select('text').text("ERREUR : "+err);
        infoG.select('circle').attr('fill','black');
//        config.dataOK=false;
      console.log(err);
    })   
}
//----------------------------------------------------------------------------------------
//- lecture par morceau ..
//----------------------------------------
// Nouvelle fonction de récupération des données en une seule requête !
var disData=[];
function getSpiltData(urldata,index) {
	disData = [];
	infoG.select('text').text('requête OI');
	infoG.select('circle').attr('fill','orange');
    var opt = fetch(urldata, {method: 'GET',headers: new Headers({'Access-Control-Allow-Origin':'*','Accept':'application/json',
        'mode':'no-cors','credentials':'includes','Authorization':'basic '+code})}).then(response => {
        return response.json();
        })
    .then(data => { 
            disData[index]=data;
            dispatch.call('partial');
        })
    .catch(err => {
        infoG.select('text').text("ERREUR : "+err);
        infoG.select('circle').attr('fill','black');
        config.dataOK=false;
      console.log(err);
    })   
}
//- dispatch 'partial'
function assData() {
    //    console.log(disData.length,from_to.length)
    if (disData.length == (from_to.length-1)) {
        infoG.select('text').text('données Chargées !');
        infoG.select('circle').attr('fill','yellow');
        console.log(disData);
        let data=[];
        disData.forEach((a,i)=>{
            if (i==0) {data=a.slice();} else 
            { a.forEach((b,j)=>
                data[j].values.push(...b.values));}
        });
        console.log(data);
        compileData(data);
    } else {
        infoG.select('text').text("réception  > "+(disData.length/(from_to.length-1)*100.0).toFixed(0)+ ' <');
        infoG.select('circle').attr('fill','violet');
    }
}
function compileData(data) {
    CumulData=[],DivData=[],AllData=[];
    listeVal.forEach( (a,i) => {
        let o = data.find( f => { return (f.dataReference == a.nom);});
            if (o != undefined) {
                listeVal[i]['unit']= o.unit;
                listeVal[i]['values']= o.values;
            }
        });
    infoG.select('text').text("Données disponibles !");
    infoG.select('circle').attr('fill','#03C03C');
    config.dataOK=true;
    // on reparti les data
    data.forEach(a=>{
        let f=listeVal.filter(b=>b.nom==a.dataReference);// console.log('data',f);
            switch (f[0].select) {
                case 1 : CumulData.push(a);break;
                case 2 : AllData.push(a);break;
                case 3 : DivData.push(a);break;
            }
        });
//          console.log('AllData',AllData); console.log('CumulData',CumulData); console.log('DivData',DivData);
    cumulCompute();
    if (DivData.length >0) divCompute();
    dataCompute();
    selGraphe=0;
    selCourbe=indexRef;
    dispatch.call('load');
}
//-----
function getAllTag() {
//      let opt = fetch(urlData, {method: 'GET',headers: new Headers({'Access-Control-Allow-Origin':'*','Accept':'application/json','credentials':'includes','withCredentials': 'true','Authorization':'basic '+code})})
        let opt = fetch(urlData, {method: 'GET',headers: new Headers({'Accept':'application/json',
            'guard':'request-no-cors','Access-Control-Allow-Credentials':'true','withCredentials': 'true','Authorization':'basic '+code})})
		.then(response => {
		return response.json();
		})
		.then(data => {
		// JSON Data
			AllTag = data.slice();
			config.tagOK = true;
            infoG.select('text').text("Tous les tags sont chargés !");
            infoG.select('circle').attr('fill','green');
			dispatch.call('load');
		})
		.catch(err => {
		// Do something for an error here
			console.log('pas de récupération des données');
            infoG.select('text').text("Erreur "+err);
            infoG.select('circle').attr('fill','black');
		});
}
//-----------------------------------------------------------------------------------------------------
//
//   SCATTER PLOT MATRIX
//
//
function matrix() {
		doGraphe(1);
        infoG.select('text').text("Préparation des nuages ... ");
        infoG.select('circle').attr('fill','yellow');
        nbTag = AllData.length - 1;
        let size = Math.round((window.innerHeight-margin.top-margin.bottom) / nbTag)-10, padding =10;
        if (matWid) {
            size = Math.round(width / nbTag);
        }

		var x = d3.scaleLinear()
			.range([padding / 2, size - padding / 2]);
		var y = d3.scaleLinear()
			.range([size - padding / 2, padding / 2]);
		var xAxis = d3.axisBottom()
			.scale(x)
			.ticks(6);
		var yAxis = d3.axisLeft()
			.scale(y)
		    .ticks(6);
    //----------------------------------------------
    // création de la selection 
    //
    var brush = d3.brush()
          .on("start", brushstart)
          .on("brush", brushmove)
          .on("end", brushend)
          .extent([[0,0],[size,size]]);

    //----------------------------------------------
    //---- Gestion de la palette de couleurs 
    //
	dataCompute(); //couleurCompute();
        svg.append('g').selectAll('circle').data(couleur).enter()
            .append('circle')
            .attr('cx',(d,i)=>{return i*14+margin.left+(width-14*8);})
            .attr('cy',0).attr('r',5).style('fill',(d)=>{return d;});

		// structuration des Data
		var domainByTrait = {},traits=[];

		AllData.forEach(function(d,i){ if (i!=indexRef) {   
			traits.push(d.dataReference);
			yMax = Math.max.apply(Math, AllData[i].values.map(function(o) { 
                    return (unSelect.find(a=>{return o.timestamp==a;}) == undefined)? o.value:-Infinity;
            }));
			yMin = Math.min.apply(Math, AllData[i].values.map(function(o) { 
                    return (unSelect.find(a=>{return o.timestamp==a;}) == undefined)? o.value:Infinity;
            }));
			domainByTrait[d.dataReference]=[];
			domainByTrait[d.dataReference].push(yMin,yMax);
			}
		});
		n = traits.length;
        // on ajuste le svg
        svg.attr("viewBox", "0 0 "+(width + margin.left + margin.right)+" "+((n)*(size+padding)+30))
        seed.y = ((n)*(size+padding));
        if (config.arbreOK)  arbre.regenerate(false);

		xAxis.tickSize(size * n);
		yAxis.tickSize(-size * n);
//		console.log(traits,domainByTrait,n);
//	 intervals de la sélection Brush
		var brushinfo = brushsel(traits);
        var brushinfoG = svg.append('g').selectAll('g').data(brushinfo).enter()
            .append('g').attr('id','fourchette');
        brushinfoG.append('text').attr('text-anchor','middle')
            .attr('dx',(d,i)=>{return (n-i-0.5)*size+margin.left;})
            .attr('dy',18).style('fill','black').text(d=>d.x);

// les axes ...
    let x_axe = graph.selectAll(".x.axis")
            .data(traits)
            .enter().append("g")
            .attr("class", "x axis")
            .attr("transform", function(d, i) { return "translate(" + (n - i - 1) * size + ",0)"; })
            .each(function(d) { 
                x.domain(domainByTrait[d]);
                d3.select(this).call(xAxis)
                  .selectAll('text')
                    .attr('y',0)
                    .attr("dx", "-.35em")
                    .attr("dy", ".35em")
                    .attr("transform", "translate(0,"+(n*size)+")rotate(-90)")
                    .style("text-anchor", "end")
                ; });

    graph.selectAll(".y.axis")
            .data(traits)
            .enter().append("g")
            .attr("class", "y axis")
            .attr("transform", function(d, i) { return "translate(0," + i * size + ")"; })
            .each(function(d) { y.domain(domainByTrait[d]); d3.select(this).call(yAxis); });
    var cell = graph.selectAll(".cell")
            .data(cross(traits, traits))
            .enter().append("g")
            .attr("class", "cell")
            .attr("transform", function(d) { return "translate(" + (n - d.i - 1) * size + "," + d.j * size + ")"; })
            .each(plot);
    //----------------------------------------------------
    // label des diagonales -> on rappelle le label ici
    //
    cell.filter(function(d) { return d.i === d.j; }).append("text")
      .attr("x", padding)
      .attr("y", padding)
      .attr("dy", ".71em").style('fill','blue')
      .text(function(d) { return d.x; });

    cell.call(brush);

    infoG.select('text').text("Done !");
    infoG.select('circle').attr('fill','green');

    //---------------------------------
    // les fonctions de tracage 
    //
	function plot(p) {

      var cell = d3.select(this);

      x.domain(domainByTrait[p.x]);
      y.domain(domainByTrait[p.y]);

      cell.append("rect")
        .attr("class", "frame")
            .attr("x", padding / 2)
            .attr("y", padding / 2)
            .style("pointer-events", "none")
            .attr("width", size - padding)
            .attr("height", size - padding);

      if (p.i!=p.j) {

        var circles = cell.selectAll("circle")
            .data(AllData[indexRef].values)
            .enter().append("circle")
            .attr('cx', function(d,i) { return (unSelect.find(a=>{return d.timestamp==a;}) == undefined)?x(AllData[p.i].values[i].value):0; })
            .attr('cy', function(d,i) { return (unSelect.find(a=>{return d.timestamp==a;}) == undefined)?y(AllData[p.j].values[i].value):0; })
            .attr('r', 2)
            .style("fill", function(d,i) {
                return (unSelect.find(a=>{return d.timestamp==a;}) == undefined)? indexCouleur[i]:'white';});
        circles.on('mousedown', function () {
                });
        } else {
        var histo = cell.selectAll('rect')
            .data(AllData[indexRef].values)
            .enter().append('rect');
        }
    }

    var brushCell;

    // Clear the previously-active brush, if any.
    function brushstart(p) {
        if (brushCell !== this) {
            d3.select(brushCell).call(brush.move, null);
            brushCell = this;
            x.domain(domainByTrait[p.x]);
            y.domain(domainByTrait[p.y]);
        }
    }

    // Highlight the selected circles.
    function brushmove(p) {
        var e = d3.brushSelection(this);
		n=AllData[indexRef].values.length;
        graph.selectAll("circle").classed("hidden", function(d,i) {
        return !e
        ? false
            : (
                e[0][0] > x(AllData[p.i+0].values[i%n].value) || x(AllData[p.i+0].values[i%n].value) > e[1][0]
                || e[0][1] > y(AllData[p.j+0].values[i%n].value) || y(AllData[p.j+0].values[i%n].value) > e[1][1]
            );
        });
    }

    // If the brush is empty, select all circles.
    function brushend(p) {
        var e = d3.brushSelection(this);
        let n = traits.length;
		brushListe=[];
		if (e !== null) {
            brushint(e,brushinfo,p);
//		console.log(brushListe);
            x.domain(domainByTrait[p.x]);
            brushinfo[p.i].min = x.invert(e[0][0]);
            brushinfo[p.i].max = x.invert(e[1][0]);
            y.domain(domainByTrait[p.y]);
            brushinfo[p.j].min = y.invert(e[1][1]);
            brushinfo[p.j].max = y.invert(e[0][1]);
//			console.log(p.i,p.x,x.invert(e[0][0]),x.invert(e[1][0]));
//          console.log(p,n,traits,brushinfo);
            brushinfoG.selectAll('text').text(d=>{return '['+valFormat(d.min)+','+valFormat(d.max)+']';});
		}
        if (e === null) graph.selectAll(".hidden").classed("hidden", false);
    }

    function cross(a, b) {
        let c = [], n = a.length, m = b.length, i, j;
        for (i = -1; ++i < n;) for (j = -1; ++j < m;) c.push({x: a[i], i: i, y: b[j], j: j});
            return c;
    }
    function brushsel(a) {
        let c = [], n = a.length, i;
        for (i = -1; ++i < n;) c.push({x: a[i], i: i, min:0, max:0});
            return c;
    }
    function brushint(e,a,p) {
        let n = AllData[p.i].values.length, i;
 /*       for (i = -1; ++i < n;) {
            x.domain(domainByTrait[a[i].x]);
            a[i].min = x.invert(e[0][0]);
            a[i].max = x.invert(e[1][0]);
        }
*/
		for (i=-1;++i <n;) {
			if (e[0][0] <= x(AllData[p.i].values[i].value) && x(AllData[p.i].values[i].value) <= e[1][0] 
			&& e[0][1] <= y(AllData[p.j].values[i].value) && y(AllData[p.j].values[i].value) <= e[1][1])
				{
					brushListe.push(AllData[p.i].values[i].timestamp);
				}
		}
    }
} //-- End MATRIX SCATTERPLOT
//
//----------------------------------------------------------------
// Calcul la somme des cumuls
//
function cumulCompute() {
	// on met à jour la table des dates qui sont valides ...
	//	console.log('Avant : ',from_to);
	AllData.forEach(a=>{from_to = from_to.filter(b=> { 
			return (a.values.find(c=>{ return b==c.timestamp;}) != undefined ); 
		})});
	// console.log('Aprés AllData : ',from_to);
	CumulData.forEach(a=>{from_to = from_to.filter(b=> { let tri = a.values.find(c=>{ return b == c.timestamp;});
			return ( tri != undefined ); 
		})});
	// console.log('Aprés CumulData : ',from_to);
	// on filtre AllData et CumulData
	AllData.forEach(a=>{a.values = a.values.filter(b=> { 
			return (from_to.find(c=>{ return c==b.timestamp;}) != undefined ); 
		})});
	CumulData.forEach(a=>{a.values = a.values.filter(b=> { 
			return (from_to.find(c=>{ return c==b.timestamp;}) != undefined ); 
		})});
	listeVal.forEach(a=>{ try {a.values = a.values.filter(b=> { 
			return (from_to.find(c=>{ return c==b.timestamp;}) != undefined ); 
		})} catch (err){}});
	// console.log(AllData);
	//-- filtre ok
    let dataIn ={nom:'Données cumulées',dataReference:'Data Cumulées',unit: '*',values:[]};
	CumulData.forEach((a,i)=>{a.values.forEach( (b,j) => {
        if (i==0) {
            dataIn.values[j] = { timestamp: b.timestamp, value:b.value };
        } else {
            dataIn.values[j].value =  dataIn.values[j].value + b.value;
        } 
        ;})
		; });

    config.dataOK=true;
    AllData.push(dataIn);
	indexCumul = AllData.length - 1;
	indexRef = indexCumul;
    unSelect = [];
    let dc = (listeVal.find(a=>{return a.nom == 'Données cumulées';}));
    if (dc==undefined) {
    	listeVal.push(dataIn);
    }else{
        dc.values = dataIn.values;
    }
}
function couleurCompute() {
    let val = [], carre=[];
    AllData[indexRef].values.forEach(function(a) {
		if (unSelect.find(b=>{return a.timestamp==b;}) == undefined) val.push(a.value) ;} );
//    let average = (array) => array.reduce((a, b) => { return a + b; }) / array.length;
    let moyenne = average(val);
    val.forEach((a)=>carre.push( (a-moyenne)*(a-moyenne) ));
    let stDev = (Math.sqrt(average(carre)*(val.length/(val.length-1))));
    indexCouleur = [];
    let code = (a) => inRange(a,moyenne-3*stDev,stDev)
                         +inRange(a,moyenne-2*stDev,stDev)*2
                         +inRange(a,moyenne-stDev,stDev)*3
                         +inRange(a,moyenne,stDev)*4
                         +inRange(a,moyenne+stDev,stDev)*5
                         +inRange(a,moyenne+2*stDev,stDev)*6
                         +inRange(a,moyenne+3*stDev,stDev)*7;
//        val.forEach((a)=>indexCouleur.push(couleur[code(a)]));
    AllData[indexRef].values.forEach((a)=>indexCouleur.push(couleur[code(a.value)]));
}
//----------------------------------------------------------------
// Divise la somme des cumuls
//
function divCompute() {
	// on met à jour la table des dates qui sont valides ...
	DivData.forEach(a=>{from_to = from_to.filter(b=> { let tri = a.values.find(c=>{ return b == c.timestamp;});
			return ( tri != undefined ); 
		})});
	// on filtre AllData, CumulData et DivData
	AllData.forEach(a=>{a.values = a.values.filter(b=> { 
			return (from_to.find(c=>{ return c==b.timestamp;}) != undefined ); 
		})});
	CumulData.forEach(a=>{a.values = a.values.filter(b=> { 
			return (from_to.find(c=>{ return c==b.timestamp;}) != undefined ); 
		})});
	DivData.forEach(a=>{a.values = a.values.filter(b=> { 
			return (from_to.find(c=>{ return c==b.timestamp;}) != undefined ); 
		})});
	//-- filtre ok
    let dataIn ={nom:'Quotient',dataReference:'Quotient',unit: '€',values:[]};
//	console.log(AllData[indexCumul]);
    AllData[indexCumul].values.forEach((a,i)=> {
//		console.log(a.value,DivData[0].values[i].value);
		t= (a.value / DivData[0].values[i].value )*1000.0;
        dataIn.values.push({timestamp:a.timestamp, value:t});
    });
    unSelect=[];
    AllData.push(DivData[0]);
    AllData.push(dataIn);
	indexQuotient = AllData.length - 1;
	indexRef = indexQuotient;
    let dc = (listeVal.find(a=>{return a.nom == 'Quotient';}));
    if (dc==undefined) {
        listeVal.push(dataIn);
    }else{
        dc.values = dataIn.values;
    }
}
//
//----------------------------------------------------------------
// Calcul stat sur les data
//
function dataCompute() {
	infoG.select('text').text("Maj des Statistiques");
    infoG.select('circle').attr('fill','Orange');
	//functions globales
//	let average = (array) => array.reduce((a, b) => { return a + b; }) / array.length;
	let code = (a) => inRange(a,moyenne-3*stDev,stDev)
                         +inRange(a,moyenne-2*stDev,stDev)*2
                         +inRange(a,moyenne-stDev,stDev)*3
                         +inRange(a,moyenne,stDev)*4
                         +inRange(a,moyenne+stDev,stDev)*5
                         +inRange(a,moyenne+2*stDev,stDev)*6
                         +inRange(a,moyenne+3*stDev,stDev)*7;
    //
    // calcul des stats pour la Reférence

	// calcul  des stats ...
    listeVal.forEach((a,i)=>{
      if(a.select != 0)
      {
        let val = [], carre=[], indexCode = [];
        a.values.forEach( (c,j)=> {
          if (unSelect.find(b=>{return c.timestamp==b;}) == undefined) val.push(c.value) ;} );
        a['moyenne']=(average(val));
        val.forEach((f)=>carre.push( (f-a.moyenne)*(f-a.moyenne) ));
        a['stDev'] = (Math.sqrt(average(carre)*(val.length/(val.length-1))));
        a['max'] = (Math.max.apply(Math, a.values.map(function(o) { return (unSelect.find(b=>{return o.timestamp==b;}) == undefined)?o.value:-Infinity; })));
        a['min'] = (Math.min.apply(Math, a.values.map(function(o) { return (unSelect.find(b=>{return o.timestamp==b;}) == undefined)?o.value:Infinity; })));
        //maxVal(a.values,'value');
//        val.forEach((a)=>indexCode.push(code(a)));
        let fq=zerosV(9);
        a.values.forEach(b=>{
            if (unSelect.find(c=>{return b.timestamp==c;}) == undefined) {
                f=(Math.max(Math.min(8,Math.round((b.value-a.moyenne)/a.stDev)+4),0));
                fq[f] += 1;}
            });
        //console.log(fq);
        a['frequence'] = fq;
      }
    });
	infoG.select('text').text("Statistiques ok");
    infoG.select('circle').attr('fill','Green');
	couleurCompute();
}
//----------------------------------------------
// calcul des composabtes principales ...
//
function acp() {
    // on norme la matrice ...
    let val = [],valT = [],ind=-1,result=[],temporelle=[],couleur=[],first=true;
    listeVal.forEach((a,i)=>{
      if(a.select == 2)
      {
        val.push([]);ind++;
        result.push({nom:a.nom});
        a.values.forEach( (c,j)=> {
          if (unSelect.find(b=>{return c.timestamp==b;}) == undefined) {
            val[ind].push((c.value-a.moyenne)/a.stDev) ;
            if (first) { 
              temporelle.push(c.timestamp);
              couleur.push(indexCouleur[j]);
            }
          }
       } );
        a['normee'] = val[ind];
      if (first) first=false;
      }
    });
//        val.forEach((a,i)=> { valT.push([]) ;            val.forEach( b => valT[i].push(a*b)); }); 
    valT = transpose(val);
    valT = matrixDot(val,valT);
    let covVal=covalence(val); //console.log('covalence :  ',covVal);
    corVal = correlation(covVal); //console.log('correlation : ',corVal);
    let vp = jacobi(corVal,100,corVal.length,0.0);
    let s =vp.valeurs.slice(), o=[];
    s  = s.sort((a, b) => b - a);
    s.forEach(a=>o.push(vp.valeurs.indexOf(a)) );
//    console.log(o);
    let f=[],c=zeros(corVal.length,corVal.length);
    result.forEach((a,i)=> {f.push([]);o.forEach((b,j)=>{
        f[i].push(vp.vecteurs[i][b]*Math.sqrt(vp.valeurs[b])) ;
        c[j][i] = vp.vecteurs[i][b] ;});
    });
//    console.log(f);
    result['ordre']=o;
    result['vecteurs']=vp.vecteurs;
    result['valeurs']=vp.valeurs;
    result['facteurs']=f;
    result['corr']=c;
    result['temporelle']=temporelle;
    result['couleurs']=couleur;
    s.forEach((a,i)=> { 
        result[i]['f']=f[i];
        result[i]['c']=corVal[i];
      });
    let ip = matrixDot(transpose(vp.vecteurs),val);
    result['projections']=ip;
//    console.log('test proj.',ip);
//    console.log(ip[o[0]],ip[o[1]]);
    console.log('acp analyse: ',result);
	return result;
}

//let average = (array) => array.reduce((a, b) => { return a + b; }) / array.length;

function acp_test() {
temporelle=['Alfasud TI','Audi' , 'Simca','Citroen GS Club','Fiat','Lancia Beta','Peugeot','Renault 16 TL','Renault 30','Toyota Corolla','Alfetta','Princess','Datsun-200L','Taunus-2000','Rancho','Mazda-9295','Opel-Rekord','Lada-1300'];
test=[[-0.77509889, -0.28335818, -1.88508077 ,-1.09734528 ,-1.56900676, 0.56976043],
[-0.12016326 ,0.01963869, 1.60580955, 2.0010414, 0.23416142, 0.14597168],
[-0.92920139, -0.83885242, -0.44217944, 0.25819889, -0.21663062, -0.53209032],
[-1.12733318, -1.29334771 ,-1.00072189, -1.09734528, -1.11821472, -0.61684807],
[-0.12841875, 0.67613189, 0.25599862 ,-0.51639778 ,0.19659542, 0.56976043],
[-0.9209459, -0.13185975 ,-0.20945342 ,0.45184806 ,0.0087654 ,0.14597168],
[ 0.45221746, -0.28335818 ,0.72145067 ,0.45184806 ,0.60982146 ,-0.36257482],
[-0.18345536 ,-1.49534562 ,-0.44217944, -0.71004695, -0.51715865, -1.54918332],
[ 2.84080623 ,2.19111619 ,0.86108628 ,1.22644473 ,1.81193359 ,1.84112668],
[-1.28143568 ,-1.49534562 ,-1.60580955, -1.87194195, -1.98223281 ,-1.54918332],
[-0.16969621 ,1.23162613 ,-0.25599862, -0.90369611 ,-0.14149861, 1.41733793],
[ 0.45772112 ,-0.13185975, 0.53526985 ,1.03279556 ,0.60982146, -0.02354382],
[ 1.0080872 ,1.53462299 ,1.65235475 ,0.45184806 ,2.18759363, 0.14597168],
[ 0.99432805 ,0.67613189 ,0.20945342 ,0.64549722 ,0.0087654 ,0.73927593],
[-0.5219305 ,-0.2328587, -0.11636301 ,-0.12909944 ,0.37691224 ,-1.21015232],
[ 0.37791804, -0.08136027 ,0.30254383 ,-0.32274861 ,0.12146341, 0.56976043],
[ 0.95580242 ,0.77713084 ,1.18690271, 1.22644473 ,0.30929343 ,1.24782243],
[-0.92920139 ,-0.83885242, -1.37308353 ,-1.09734528, -0.9303847 ,-1.54918332]];
/*test = [[6,6,5,5.5,8],
[8,8,8,8,9],
[6,7,11,9.5,11],
[14.5,14.5,15.5,15,8],
[14,14,12,12,10],
[11,10,5.5,7,13],
[5.5,7,14,11.5,10],
[13,12.5,8.5,9.5,12],
[9,9.5,12.5,12,18]];
/*test = [[1.,2.,3.],
        [2.,1.,4.],
        [3.,4.,1.]]
 */   // calcul  des stats ...
 test=transpose(test);
    let stat=[],test2=[],ind=-1;
    test.forEach((a)=>{
        let val = [], carre=[], indexCode = [];
        a.forEach( (c)=> {
           val.push(c);})
        let moyenne=(average(val));
        val.forEach((f)=>carre.push( (f-moyenne)*(f-moyenne) ));
        let stDev = (Math.sqrt(average(carre)));
//        let stDev = (Math.sqrt(average(carre)*(val.length/(val.length-1))));
        test2.push([]);ind++;
        val.forEach(b=>test2[ind].push((b-moyenne)/stDev));
        stat.push({moyenne:moyenne,stDev:stDev});
    });
console.log('stat : ',stat,'matrice normée : ',test2);
    testT = transpose(test); // mettre test2 si pas normée
    testT = matrixDot(test,testT);
    let covTest=covalence(test);
    console.log('covalence :  ',covTest);
    corVal = correlation(covTest); // corVal données globale pour affichaeg matrice
    console.log('correlation : ',corVal);
    let result= [{nom:'CYL'},{nom:'PUISS'},{nom:'LONG'},{nom:'LARG'},{nom:'POIDS'},{nom:'V.MAX'}];
    let vp = jacobi(corVal,100,corVal.length,0.0);
//xx    vp.valeurs.forEach((a,i)=>{result[i]['vp']=a;});
    let s =vp.valeurs.slice(), o=[];
    s  = s.sort((a, b) => b - a);
//    console.log(s,vp.valeurs);
    s.forEach(a=>o.push(vp.valeurs.indexOf(a)) );
    console.log(o);
    let f=[],c=zeros(corVal.length,corVal.length);
    result.forEach((a,i)=> {f.push([]);o.forEach((b,j)=>{
        f[i].push(vp.vecteurs[i][b]*Math.sqrt(vp.valeurs[b])) ;
        c[j][i] = vp.vecteurs[i][b] ;});
    });
//    console.log(f);
    result['ordre']=o;
    result['vecteurs']=vp.vecteurs;
    result['valeurs']=vp.valeurs;
    result['facteurs']=f;
    result['corr']=c;
    result['temporelle']=temporelle;
    s.forEach((a,i)=> { 
        result[i]['f']=f[i];
        result[i]['c']=corVal[i];
      });
    console.log('acp : ',result);
    let ip = matrixDot(transpose(vp.vecteurs),test);
    result['projections']=ip;
    console.log('test proj.',ip);
    console.log(ip[o[0]],ip[o[1]]);
//	console.log('tst new jacobi');
//    jacobiV2(corVal,0,corVal.length,0.);
	return result;
}
//----------------------------------------------------------------
// Analyse correlation et plus ...
//
function analyse() {
	doGraphe(2);
    nbTag = AllData.length - 1;
    let size = Math.round(width / nbTag), padding =40;

	var eigen;
    if (config.dataOK) {eigen = acp();} // on calcul réel 
    else {
        eigen = acp_test(); //console.log('Resultat VP',eigen);
//        let F=matrixDot();
    } // sinon mise au point à partir de données test
    const add = (a,b) => Math.abs(a)+Math.abs(b);
	const f1_sum = eigen.corr[0].reduce(add);
    const f2_sum = eigen.corr[1].reduce(add);
	var w = (width/2)-margin.left-padding-margin.right, h = w; // on test ...
	// on ajuste le svg
    svg.attr("viewBox", "0 0 "+(width + margin.left + margin.right+padding)+" "+(2*(h+margin.top+margin.bottom+padding)));
    seed.y = h+margin.top+margin.bottom;
    if (config.arbreOK)  arbre.regenerate(false);

    //----------------------------------------------
    //---- Gestion de la palette de couleurs 
    //
        svg.append('g').selectAll('circle').data(couleur).enter()
            .append('circle')
            .attr('cx',(d,i)=>{return i*14+margin.left+(width-14*8);})
            .attr('cy',0).attr('r',5).style('fill',(d)=>{return d;});

	graph.selectAll('g').remove();
	
    var corr = graph.append('g')
        .attr('id','correlation')
        .attr('transform', 'translate(' + margin.left + ',0)');
    
	let Xscale = d3.scaleBand().rangeRound([0,w]),
        Yscale = d3.scaleBand().rangeRound([h,0]),
        ColorScale = d3.scaleLinear().domain([-1,0,1]).range(['red','white','blue']);
    let Rscale = d3.scaleSqrt().domain([0,1]);

	nbTag = corVal.length;
    txtSize = 1.3*8/nbTag;

	Xscale.domain(d3.range(nbTag));
	Yscale.domain(d3.range(nbTag));
    Rscale.range([0,0.5*Xscale.bandwidth()]);

	var corData=[], i=-1;
	corVal.forEach((a)=>{
		++i; let j=-1;
		a.forEach((b)=> corData.push({x:++j,y:i,value:b}));
	});
//	console.log(nbTag,corData);
    let cells = corr.append('g')
            .attr('id', 'cells')
            .selectAll('empty')
            .data(corData)
            .enter().append('g')
            .attr( 'class', 'cell')
            .style('pointer-events', 'all');

    let rects = cells.append('rect')
            .attr('x', function(d) { return Xscale(d.x); })
            .attr('y', function(d) { return Xscale(d.y); })
            .attr('width', Xscale.bandwidth())
            .attr('height', Yscale.bandwidth())
            .style('fill', 'none')
            .style('stroke', 'none')
            .style('stroke-width', '1');

    let circles = cells.append('circle')
		.attr('cx', function(d) {return Xscale(d.x) + 0.5*Xscale.bandwidth(); })
        .attr('cy', function(d) {return Xscale(d.y) + 0.5*Yscale.bandwidth(); })
        .attr('r', function(d) {return (d.x===d.y)?1:Rscale(Math.abs(d.value)); })
		.style('fill', function(d) { return ColorScale(d.value); }).style('opacity',d=>{return (d.x<d.y)?0.2:1.0;});

	let textes = cells.append('text')
		.attr('dx', function(d) {return Xscale(d.x) + 0.5*Xscale.bandwidth(); })
        .attr('dy', function(d) {return Xscale(d.y) + 0.6*Yscale.bandwidth(); })
        .text( d=> d.value.toFixed(2)).attr('text-anchor','middle').style('font-size',txtSize+'vw')
		.style('fill', function(d) { return ColorScale(d.value); }).attr('visibility',d=>{return (d.x>=d.y)?'hidden':'visible';});

    corr.selectAll('g.cell')
		.on('mouseover', function(d) {
           d3.select(this)
			.select('rect')
            .style('stroke', '#FE6F5E');

                var xPos = parseFloat(d3.select(this).select('rect').attr('x'));
                var yPos = parseFloat(d3.select(this).select('rect').attr('y'));
                corr.append('text')
                    .attr('class','corrlabel')
//                  .attr('dx',Xscale(d.x)).attr('dy',h+10)
                    .attr('dx',w/2).attr('dy',h+10).style('font-size','1.3vw')
                    .text(eigen[d.x].nom+' - ['+eigen[d.x].f[0].toFixed(3)+' / '+eigen[d.x].f[1].toFixed(3)+']')
                    .style('dominant-baseline', 'middle').style('text-anchor', 'middle');

                corr.append('text')
                    .attr('class', 'corrlabel')
                    .text(eigen[d.y].nom+' - ['+eigen[d.y].f[0].toFixed(3)+' / '+eigen[d.y].f[1].toFixed(3)+']') //(data.vars[d.row])
                    .style('text-anchor', 'middle').style('font-size','1.3vw')
					.attr('transform', 'translate(' + (-10) + ',' + (h/2) + ')rotate(270)');

/*                corr.append('rect')
                    .attr('class', 'tooltip')
					.attr('x', xPos + 10)
                    .attr('y', yPos + 10)
                    .attr('width', 40)
                    .attr('height', 20)
                    .style('fill', 'rgba(200, 200, 200, 0.5)')
                    .style('stroke', 'black'); */

                corr.append('text')
                    .attr('class', 'tooltip')
                    .attr('x', Xscale(d.x)+0.5*Xscale.bandwidth()) //xPos + 10)
                    .attr('y', Xscale(d.y)+0.6*Yscale.bandwidth()) //yPos + 15)
                    .style('text-anchor', 'middle')
                    .style('font-family', 'sans-serif')
                    .style('font-size', txtSize+'2vw')
                    .style('font-weight', 'bold')
                    .style('fill', 'black')
                    .attr('visibility',(d.x<d.y)?'hidden':'visible')
                    .text(d3.format('.2f')(d.value));
            })
            .on('mouseout', function(d) {
                d3.select('#corrtext').remove();
                d3.selectAll('.corrlabel').remove();
                d3.select(this)
                    .select('rect')
                    .style('stroke', 'none');
                //Hide the tooltip
                d3.selectAll('.tooltip').remove();
            })
            .on('click', function(d) {
                plotScatter(d.x, d.y); })
			;
    //---------
    // cadran HD
    let scatter = graph.append('g')
            .attr('id', 'scatterplot')
            .attr('transform', 'translate(' + (w + 2*(margin.left)+padding+margin.right) + ',0)');

/*    scatter.append('text')
        .text('Scatter plot')
        .attr('class', 'plottitle')
        .attr('x', w/2).attr('y', -margin.top/2)
        .style('dominant-baseline', 'middle').style('text-anchor', 'middle');
*/
    var plotScatter = function(x, y) {
        let Xval=[],XCol=[];
        listeVal.find(a=>{ return a.nom==eigen[x].nom;}).values.forEach
			((b,i)=> { if (unSelect.find(o=>{return b.timestamp==o;}) === undefined) { Xval.push(b.value);XCol.push(indexCouleur[i]);}});
        let Yval=[];
        listeVal.find(a=>{ return a.nom==eigen[y].nom;}).values.forEach
			(b=> { if (unSelect.find(o=>{return b.timestamp==o;}) === undefined) Yval.push(b.value)});

        d3.selectAll('.points').remove();
        d3.selectAll('.axis').remove();
        d3.selectAll('.scatterlabel').remove();

        let xScale = d3.scaleLinear()
            .domain(d3.extent(Xval))
            .range([0, w]);
        let yScale = d3.scaleLinear()
            .domain(d3.extent(Yval))
            .range([h-margin.top, 0]);
        let xAxis = d3.axisBottom()
            .scale(xScale)
            .ticks(10)
            .tickSize(-w);
        let yAxis = d3.axisLeft()
            .scale(yScale)
            .tickSize(-h); //xx ep ?
        scatter.append('g')
            .attr('class', 'x axis')
            .attr('transform', 'translate(0,' + h + ')')
            .call(xAxis);

        scatter.append('g')
            .attr('class', 'y axis')
            .call(yAxis);

        scatter.append('g')
            .attr('class', 'points')
            .selectAll('empty')
            .data(d3.range(Xval.length))
            .enter().append('circle')
            .attr('class', 'point')
            .attr('cx',function(d) { return xScale(Xval[d]);})
            .attr('cy', function(d) { return yScale(Yval[d]);})
            .attr('r', 4)
            .style('stroke', 'none')
            .style("fill", function(d,i) {
                return (unSelect.find(a=>{return d.timestamp==a;}) == undefined)? XCol[i]:'white';}); // reindex des couleurs !

        scatter.append('text')
            .text(eigen[x].nom)
            .attr('class', 'scatterlabel').style('font-size','1.3vw')
            .attr('x',w/2).attr('y',h +margin.top)
            .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle');

        scatter.append('text')
            .text(eigen[y].nom)
            .attr('class', 'scatterlabel').style('font-size','1.3vw')
            .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle')
            .attr('transform', 'translate(' + (-margin.left-padding) + ',' + (h/2) + ')rotate(270)');

    }
    //----------------
    // cercle des corrélations.
    // cadran BG
    //
    let cercleCorr = graph.append('g')
            .attr('id', 'cercleplot')
            .attr('transform', 'translate('+margin.left+','+(h+2*margin.top)+')');

    cercleCorr.append('text')
        .text('Cercle des corrélations ACP').style('font-size','1.2vw')
        .attr('x', w/2).attr('y', h/2)
        .style('dominant-baseline', 'middle').style('text-anchor', 'middle');

        let Xval=[], Yval=[];
        for (i=-1;++i<nbTag;) {
            Xval.push(eigen[i].f[0]);
            Yval.push(eigen[i].f[1]);
        };

        let xScale = d3.scaleLinear()
  //          .domain(d3.extent(Xval))
            .domain([-1,1])
            .range([0, w]);
        let yScale = d3.scaleLinear()
//            .domain(d3.extent(Yval))
            .domain([-1,1])
            .range([h, 0]);
        let xAxis = d3.axisBottom()
            .scale(xScale)
            .ticks(10)
            .tickSize(-w);
        let yAxis = d3.axisLeft()
            .scale(yScale)
            .tickSize(-h); //xx ep ?
        cercleCorr.append('g')
//            .attr('class', 'x axis')
            .attr('transform', 'translate(0,' + h + ')')
            .call(xAxis);

        cercleCorr.append('g')
//            .attr('class', 'y axis')
            .call(yAxis);

        cercleCorr.append('circle')
            .attr('cx', w/2).attr('cy', h/2)
            .attr('r',w/2).style('stroke','blue').style('fill','#ccccff').style('opacity',0.6);
        
        cercleCorr.append('g')
            .attr('class', 'corrPoints')
            .selectAll('empty')
            .data(d3.range(Xval.length))
            .enter().append('circle')
            .attr('class', 'point')
            .attr('cx',function(d) { return xScale(Xval[d]);})
            .attr('cy', function(d) { return yScale(Yval[d]);})
            .attr('r', 4)
            .style('stroke', 'none')
            .style('fill', 'blue')
            .on('mouseover',affTextEigen)
            .on('mouseout',function(d) {cercleCorr.selectAll('#eigenNom').remove();});

function affTextEigen(d) {
    //console.log(d);
    //console.log('fi',f1_sum,f2_sum,eigen.corr[0][d],eigen.valeurs[eigen.ordre[0]]);
        cercleCorr.append('text').attr('id','eigenNom')
            .text(eigen[d].nom+' ['+eigen[d].f[0].toFixed(3)+' / '+eigen[d].f[1].toFixed(3)+']'+
                ' (F0='+(eigen[d].f[0]*eigen[d].f[0]/eigen.valeurs[eigen.ordre[0]]*100.0).toFixed(1)+'%)'+
                ' (F1='+(eigen[d].f[1]*eigen[d].f[1]/eigen.valeurs[eigen.ordre[1]]*100.0).toFixed(1)+'%)')
            .attr('class', 'scatterlabel').style('font-size','1.2vw')
            .attr('x',xScale(Xval[d])+5).attr('y',yScale(Yval[d])-5)
            .attr('text-anchor', 'start').attr('dominant-baseline', 'start');
        }

        cercleCorr.append('text')
            .text('F1 -> '+(eigen.valeurs[eigen.ordre[1]]/nbTag*100.0).toFixed(1)+' %')
            .attr('class', 'corrPoid').style('font-size','1.2vw')
            .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle')
            .attr('transform', 'translate(' + (-margin.left) + ',' + (h/2) + ')rotate(270)');
        cercleCorr.append('text')
            .text('F0 -> '+(eigen.valeurs[eigen.ordre[0]]/nbTag*100.0).toFixed(1)+' %')
            .attr('class', 'corrPoid').style('font-size','1.2vw')
            .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle')
            .attr('transform', 'translate(' + w/2 + ',' + (h+margin.top) + ')');

    //----------------
    // projection factorielle
    // cadran BD
    //
    let projFactor = graph.append('g')
            .attr('id', 'projplot')
            .attr('transform', 'translate('+(w+2*margin.left+padding+margin.right)+','+(h+2*margin.top)+')');

    projFactor.append('text')
        .text('Projection factorielle des items')
        .attr('x', w/2).attr('y', h+margin.top+margin.bottom).style('font-size','1.2vw')
        .style('dominant-baseline', 'middle').style('text-anchor', 'middle');

        let X0val=[], Y1val=[];
//        console.log(eigen.projections[0].length,eigen.projections[eigen.ordre[0]]);
        for (i=-1;++i<eigen.projections[0].length;) {
            X0val.push(eigen.projections[eigen.ordre[0]][i]);
            Y1val.push(eigen.projections[eigen.ordre[1]][i]);
        };
        const maxAbs = (a,b) => { if (Math.abs(a)>Math.abs(b)) {return Math.abs(a);} else{ return Math.abs(b);} };
        const x0M = X0val.reduce(maxAbs);
        const y1M = Y1val.reduce(maxAbs);
        const max = Math.max(x0M,y1M);
        let x0Scale = d3.scaleLinear()
//            .domain(d3.extent(X0val))
            .domain([-max,max])
            .range([0, w]);
        let y1Scale = d3.scaleLinear()
//            .domain(d3.extent(Y1val))
            .domain([-max,max])
            .range([h, 0]);
        let x0Axis = d3.axisBottom()
            .scale(x0Scale)
            .ticks(10)
            .tickSize(-w);
        let y1Axis = d3.axisLeft()
            .scale(y1Scale)
            .tickSize(-h); //xx ep ?
        projFactor.append('g')
//            .attr('class', 'x axis')
            .attr('transform', 'translate(0,' + h + ')')
            .call(x0Axis);

        projFactor.append('g')
//            .attr('class', 'y axis')
            .call(y1Axis);

/*        projFactor.append('circle')
            .attr('cx', w/2).attr('cy', h/2)
            .attr('r',w/2).style('stroke','blue').style('fill','white').style('opacity',0.5);
*/        
        projFactor.append('g')
            .attr('class', 'projPoints')
            .selectAll('empty')
            .data(d3.range(X0val.length))
            .enter().append('circle')
            .attr('class', 'point')
            .attr('cx',function(d) { return x0Scale(X0val[d]);})
            .attr('cy', function(d) { return y1Scale(Y1val[d]);})
            .attr('r', 4)
            .style('stroke', 'none')
            .style('fill', d=>{return eigen.couleurs[d];})//'red')
            .on('mouseover',affTextItem)
            .on('mouseout',function(d) {projFactor.selectAll('#eigenItem').remove();})
            ;
function affTextItem(d) {
    //console.log(d);
    //console.log('fi',f1_sum,f2_sum,eigen.corr[0][d],eigen.valeurs[eigen.ordre[0]]);

        projFactor.append('text').attr('id','eigenItem')
            .text(toDate(eigen.temporelle[d]))
            .attr('class', 'scatterlabel').style('font-size','1.2vw')
            .attr('x',x0Scale(X0val[d])+5).attr('y',y1Scale(Y1val[d])-5)
            .attr('text-anchor', 'start').attr('dominant-baseline', 'start');
        }
    /*
        cercleCorr.append('text')
            .text('F1 -> '+(eigen.valeurs[eigen.ordre[1]]/nbTag*100.0).toFixed(1)+' %')
            .attr('class', 'corrPoid').style('font-size','1.2vw')
            .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle')
            .attr('transform', 'translate(' + (-margin.left) + ',' + (h/2) + ')rotate(270)');
*/
        projFactor.append('text')
            .text('F0 -> '+(eigen.valeurs[eigen.ordre[0]]/nbTag*100.0).toFixed(1)+' %')
            .attr('class', 'corrPoid').style('font-size','1.2vw')
            .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle')
            .attr('transform', 'translate(' + w/2 + ',' + (h+margin.top) + ')');
    
}
//
//----------------------------------------------------------------
// Parametre
//
function param() {
	doGraphe(3);
    const size = 30, padding=2;
    const tab = [ size, width/2.4, 40, 65, 65, 65, 65],
        t_nom = [ 'select','nom','unit','min','max','moyenne','stDev'];
    graph.selectAll('g').remove();
    d3.select('#seconde').remove();
    // on ajuste le svg
//    console.log(listeVal.length,size);
    svg.attr("viewBox", "0 0 "+(width + margin.left + margin.right)+" "+((listeVal.length+1)*size));
    seed.y = ((listeVal.length+1)*size)-20;
    if (config.arbreOK)  arbre.regenerate(false);
    
    let paramG = graph.selectAll('g').data(listeVal).enter()
        .append('g').attr('transform',(d,i)=>{return ('translate('+(2)+','+(i*size+padding/2)+')');});
    for (let t in tab) {
        const xRect = tab.reduce((a,c,i)=>{return (i<t)?(a+c):a;},0);
        paramG.append('rect').attr('x',xRect).attr('id','stat')
            .attr('width',tab[t]-padding).attr('height',size*0.9).style('fill','#caeeb0');
        paramG.append('text').attr('x',xRect) //.attr('y',10)
            .attr('dx',padding*3).attr('y',size/2+padding).style('fill','#275')
            .text((d)=>((t>2 & d.select!=0)?valFormat(d[t_nom[t]]):d[t_nom[t]])).style('font-size','11px');
    }
    paramG.append('circle').attr('cx',15).attr('cy',size/2).style('r',size/3).style('fill','#fff');
    paramG.append('svg').attr('width',size/2).attr('height',size/2)
        .attr('x',size/4).attr('y',size/4).attr('id',(d,i)=>{ return ('sel'+i);})
        .attr('class',(d)=>{return ('icon fas fa-'+icon[d.select]);}).style('color',d=>{return couleur[d.select];});
    paramG.append('circle').attr('cx',15).attr('cy',size/2).style('r',size/3).style('fill','#fff')
        .on('click',selectVal).style('opacity',0.1);
/*
    let button = graph.append('g').on('click',saveListe)
        .on('mouseover',function(d,i){ button.select('rect').attr('fill','#FE6F5E');})
        .on('mouseout', function(d,i){ button.select('rect').attr('fill','#8cF');});
    button.append('rect').attr('x',width/2+100).attr('y',150)
        .attr('width',150).attr('height',35).attr('fill','#8cF');
    button.append('text')//.attr('x',10).attr('y',10)
        .attr('dx',width/2+175).attr('y',174).style('fill','#275').style('text-anchor','middle')
        .text('Modifier Liste').style('font-size','20px');

    let buttonCumul = graph.append('g').on('click',loadCumul)
        .on('mouseover',function(d,i){ buttonCumul.select('rect').attr('fill','#FE6F5E');})
        .on('mouseout', function(d,i){ buttonCumul.select('rect').attr('fill','#8cF');});
    buttonCumul.append('rect').attr('x',width/2+100).attr('y',250)
        .attr('width',150).attr('height',35).attr('fill','#8cF');
    buttonCumul.append('text')//.attr('x',10).attr('y',10)
        .attr('dx',width/2+175).attr('y',274).style('fill','#275').style('text-anchor','middle')
        .text('Charger Cumul').style('font-size','20px');
*/
  function selectVal(d,i,n) {
//    console.log(n);
    listeVal[i].select = (listeVal[i].select + 1) % 4;
//    sel='#sel'+i;
//    d3.select(this).attr('class',(d)=>{return ('icon fas fa-'+icon[d.select]);}).style('color','red');
//    d3.select(sel).attr('class',(d)=>{return ('icon fas fa-'+icon[d.select]);}).style('color','red');
//    console.log(i);
	updateListe();
    param();
  }
  function saveListe(d,i,n) {
    updateListe();
    button.select('rect').attr('fill','green');
    button.select('text').style('fill','white');
  }
  /*
  function loadCumul(d,i,n) {
    let url2 = urlBase+refCumul+urlTime+urlRes;
    start(url2,1);
    buttonCumul.select('rect').attr('fill','green');
    buttonCumul.select('text').style('fill','white');    
  }*/
}

function updateListe() {
    let red = '',cumul='', div ='',all ='';
    listeVal.forEach((a)=>{ 
        if (a.select!=0) (all += (all==''?'':',')+a.nom);
        if (a.select==3) (div += (div==''?'':',')+a.nom);
        if (a.select==2) (red += (red==''?'':',')+a.nom);
        if (a.select==1) (cumul += (cumul==''?'':',')+a.nom);  });
    refListe=encodeURIComponent(red);
    refCumul=encodeURIComponent(cumul);
    refDiviseur=encodeURIComponent(div);
    refAll=encodeURIComponent(all);
}
//----------------------------------------------------------------
// Sélection des valeurs par recherche aborescence  ...
//
function selection() {
	doGraphe(4);

	var w = (width-margin.left-margin.right), h = window.innerHeight - margin.top - margin.bottom; // on test ...
    var filtre=[],filtreTag='',TagFiltre=AllTag.slice;
	// on ajuste le svg
    svg.attr("viewBox", "0 0 "+(width + margin.left + margin.right)+" "+(h+margin.top+margin.bottom));
    if (config.arbreOK)  arbre.regenerate(false);

	graph.selectAll('g').remove();
    let selG = graph.append('g')
        .attr('transform', 'translate(' + 0+ ',' + margin.top + ')')
        .attr('width', w).attr('height', h);
    let sel=[];
	if (config.tagOK) {
		AllTag.forEach((a)=> a.tags.forEach((b)=>{
		let f = sel.find(c=>c.key == b.key);
		if (f == undefined) 
			{sel.push({key:b.key, values:[b.value]});} else 
			{   g = f.values.find(d=>d == b.value);
			if ( g == undefined) {
			f.values.push(b.value);} ; }
			}));
		console.log(sel);
		nbSel = sel.length; let hInt=(h/(nbSel+4));
/*
		var selTag = selG.selectAll('g').data(sel).enter().append('g')
			.attr('transform',(d,i)=> { return 'translate(100,'+((i+1)*hInt)+')'});
		selTag.append('text').text(d=>(d.key+' ('+d.values.length+')')).attr('dy','0em')
			.style('text-anchor','end').style('font-size','1.2vw') .style('font-family', 'sans-serif')
            .style('font-weight', 'bold').style('fill', 'blue')
			.attr('transform',(d,i)=>{return 'rotate('+(30-(60*i/nbSel))+')'});
		selTag.append('circle').attr('cx',10).attr('cy',(d,i)=> { return(-5+10*Math.sin((30-(60*i/nbSel))*Math.PI/180));})
			.attr('r',5).style('stroke','blue').style('fill','white')
            .on('click',selectValue)
            .on('mouseover',function(d,i){ d3.select(this).style('fill','#FE6F5E');})
            .on('mouseout',function(d,i){ d3.select(this).style('fill','white');})
*/	
        var selTag = selG.selectAll('g').data(sel).enter().append('g')
            .attr('transform',(d,i)=> { return 'translate(0,'+(i*hInt)+')'});
        selTag.append('rect').attr('width',130).attr('height',25).style('fill','#a0a')
            .on('mouseover',function(d,i){ d3.select(this).style('fill','#FE6F5E');})
            .on('mouseout',function(d,i){ d3.select(this).style('fill','#a0a');})
            .on('click',selectValue);
        selTag.append('text').text(d=>(d.key+' ('+d.values.length+')')).style('fill','white')
            .attr('dy','1.5em').attr('dx','1em').style('font-size','1.5vh');
    }
	function selectValue(a) {
        console.log(a);
        filtreTag=a.key;
        d3.select('#tagListe').remove();
		let nbVal = a.values.length, hi = Math.min(15,h/nbVal),pad=1;
		console.log(a.key,hi,nbVal,h,a.values);
        let selG2 = selG.append('g').attr('id','tagListe');
		let selectListe = selG2.selectAll('g').data(a.values).enter().append('g')
          .attr('transform',(d,i)=> {return 'translate(140,'+(i*(hi+pad))+')'})
        selectListe.append('rect').attr('width',250).attr('height',hi).style('fill','black')
            .on('mouseover',function(d,i){ d3.select(this).style('fill','#FE6F5E');})
            .on('mouseout',function(d,i){ d3.select(this).style('fill','black');})
            .on('click',selectTag);
		selectListe.append('text').text(d=>d).style('fill','white').attr('dy','1.0em').attr('dx','1em');
	}
    function selectTag(a) {
        filtre.push(filtreTag+'=='+a);
        infoG.select('text').text(filtre);
        infoG.select('circle').attr('fill','violet');
//        AllTag.forEach((f)=>console.log(f.tags.find(t=>{return (t.key==filtreTag && t.value==a);})));
       TagFiltre = AllTag.filter((f)=>{ return (f.tags.find(t=>{return (t.key==filtreTag && t.value==a);}))!= undefined;} ) ;
       updateFiltre();
    }
    function updateFiltre() {
        d3.select('#tagFiltre').remove();
        let nbVal = TagFiltre.length, hi = Math.min(15,h/nbVal),pad=1;
        let selGF = selG.append('g').attr('id','tagFiltre');
        let selectListe = selGF.selectAll('g').data(TagFiltre).enter().append('g')
          .attr('transform',(d,i)=> {return 'translate(400,'+(i*(hi+pad))+')'})
        selectListe.append('rect').attr('width',250).attr('height',hi).style('fill','blue')
            .on('mouseover',function(d,i){ d3.select(this).style('fill','#FE6F5E');})
            .on('mouseout',function(d,i){ d3.select(this).style('fill','blue');});
//            .on('click',selectTag);
        selectListe.append('text').text(d=>d.reference).style('fill','white').attr('dy','1.0em').attr('dx','1em');
    }    
}
//
//----------------------------------------------------------------
// CREDENTIALS
//
function cred() {
	doGraphe(-1);
    svg.attr("viewBox", "0 0 "+(width + margin.left + margin.right)+" "+(height + margin.top + margin.bottom))
    seed.y = height+margin.top+margin.bottom;
    if (config.arbreOK)  arbre.regenerate(false);
    var credential = [
                {name: 'username', type: 'text', display: 'Username'},
                {name: 'password', type: 'text', display: 'Password'},
                {name: 'submit', type: 'submit', display: 'Username'}
            ];
    let size={l:200,h:200};
/*    let credG = graph.append('g')
        .append('foreignObject').attr('x',10).attr('y',10).attr('width',300).attr('height',150);
    credG.append('rect').attr('x',width/2-size.l/2+margin.left).attr('y',80)
        .attr('width',size.l).attr('height',size.h).style('fill','#BCD4E6');
		*/
        d3.select('#credentials').attr('width',300).style('display','inline').raise();
        d3.select('#username').attr('placeholder',username).on('change',credClick);
        d3.select('#password').attr('placeholder',password).on('change',credClick);
        var itemJson = d3.select('#loadjson').style('display','inline').on('input',loadjson).raise();

/*    d3.select('#chart').append('form').attr('name','credentials').selectAll('input').data(credential).enter()
        .append('input').attr('id',d=>d.name)
        .attr('type',d=> d.type)
        .attr('name', d=> d.name).attr('placeholder',d=>d.display).raise();
*/
}
function credClick() {
    val = d3.select('#username').property('value');
    if (val!='') username=val;
    val = d3.select('#password').property('value');
    if (val!='') password=val;
    code =btoa(username+':'+password);
	if (username!='Username' && password != 'Password') {
		infoG.select('text').text(code+'=> OK');
		infoG.select('circle').attr('fill','blue');
		config.credOK=true;
	} else {
        infoG.select('text').text('saisir User/Password');
        infoG.select('circle').attr('fill','yellow');
    }
//	d3.select('#connexion').style('background',"yellow");
//	console.log(code);
    return false;
}
function loadjson() {
    // Check for the various File API support.
    if (window.File && window.FileReader && window.FileList && window.Blob) {
    // Great success! All the File APIs are supported.
    } else {
        alert('The File APIs are not fully supported in this browser.');
    }
    var f = event.target.files[0]; // FileList object
    var reader = new FileReader();

    reader.onload = function(event) {
        load_d3(event.target.result)
    };
    // Read in the file as a data URL.
    reader.readAsDataURL(f);
}
function load_d3(fileHandler) {
    d3.json(fileHandler).then(function(json) {
        //do stuff
//        console.log(json);
    listeVal=[];
    listeVal=json;
    unSelect=[];
    config.dataOK=false;
    infoG.select('text').text("Chargement fichier");
    infoG.select('circle').attr('fill','#d49');
	updateListe();
    });
}
function loadDashBoard() {
    d3.json("../data/dashboard.json").then(function(json) {
        listeDashboard=json;
        dispatch.call('update');
    });
}
//----------------------------------------------------------------
//
function clearSVG() {
    d3.select('#credentials').style('display','none');
    d3.select('#loadjson').style('display','none');
    graph.selectAll('g').remove();
    svg.selectAll('circle').remove();
    d3.select('#seconde').remove();
    svg.selectAll("#fourchette").remove();
}
//----
//
function updateDashboard() {
    console.log(listeDashboard);
    let refDashboard='';
    let now = new Date(Date.now());
    let today = new Date(now);
    today.setHours(0,0,0,0);
    ref = today.getTime();
    let yesterday = new Date(ref-3600000*24);
    let tomorrow = new Date(ref+3600000*24);
    //console.log(today,new Date(today).toISOString());
    urlTime = '&from='+encodeURIComponent(yesterday.toISOString())+'&to='+encodeURIComponent(today.toISOString());
    console.log(urlTime);
    for(let i=-1;++i<(listeDashboard.length);) {
        refDashboard += (refDashboard==''?'':',')+listeDashboard[i].tag;
    }
    url = urlBase+encodeURIComponent(refDashboard)+urlTime+'&resolution=PT1H';
    console.log(url);
    getDashData(url,'hier');
    urlTime = '&from='+encodeURIComponent(new Date(now.getTime()-3000000).toISOString())+'&to='+encodeURIComponent(now.toISOString());
    url = urlBase+encodeURIComponent(refDashboard)+urlTime+'&resolution=PT5M';
    console.log(url);
    getDashData(url,'now');
    urlTime = '&from='+encodeURIComponent(today.toISOString())+'&to='+encodeURIComponent(now.toISOString());
    url = urlBase+encodeURIComponent(refDashboard)+urlTime+'&resolution=PT1H';
    console.log(url);
    getDashData(url,'today');
    let first = new Date(Date.now());
    first.setHours(0,0,0,0);
    first.setDate(1);
    urlTime = '&from='+encodeURIComponent(first.toISOString())+'&to='+encodeURIComponent(today.toISOString());
    url = urlBase+encodeURIComponent(refDashboard)+urlTime+'&resolution=P1D';
    console.log(url);
    getDashData(url,'mois');
}
//-------------------------------------------------------------------------------------
//  Afficahge du dashBoard
//-
function Dashboard() {

    if (Object.keys(dashData).length == 4) {
        console.log(dashData);
        let data = [];
        for (i=-1;++i<dashData.hier.length;) {
            let ii = listeDashboard.filter(a=>{ return a.tag == dashData.now[i].dataReference;});
            data.push({'nom':dashData.now[i].dataReference, 
                'now':(dashData.now[i].values[0].value),
                'nowp':(dashData.now[i].values[0].value/ii[0].cmj)/10,
                'today':averageOI(dashData.today[i].values).toFixed(0),
                'todayp':averageOI(dashData.today[i].values).toFixed(0)/ii[0].cmj/10,
                'hier':averageOI(dashData.hier[i].values),
                'hierp':averageOI(dashData.hier[i].values)/ii[0].cmj/10,
//                'cmj':listeDashboard[i].cmj,
                'mois':dashData.mois[i].values,
                'jour':dashData.today[i].values
                });
//            console.log(i,ii);
            data[i].mois[0]['div']=ii[0].cmj*10;
            data[i].jour[0]['div']=ii[0].cmj*10;
            data[i]['c']=ii[0].c;
            data[i]['l']=ii[0].l;
        }
        console.log('data',data);
        doGraphe(5);
		var w = (width-margin.left-margin.right), h = window.innerHeight - margin.top - margin.bottom; // on test ...
		// on ajuste le svg
		svg.attr("viewBox", "0 0 "+(width + margin.left + margin.right)+" "+(h+margin.top+margin.bottom));
		if (config.arbreOK)  arbre.regenerate(false);

		graph.selectAll('g').remove();
/*
		let DashG = graph.append('g')
			.attr('transform', 'translate(' + margin.left+ ',' + margin.top + ')')
			.attr('width', w).attr('height', h-500); //epxxx enlever -500
		let product = DashG.selectAll('g').data(data).enter().append('g');
        const dec=45;
		
        product.append('rect')
            .attr('x',(d,i)=>{return i*dec;}).attr('y',20).style('fill','white').style('stroke','blue')
            .attr('height',100).attr('width',25);
		product.append('rect')
			.attr('x',(d,i)=>{return i*dec;}).attr('y',(d)=>{return 120-d.hierp;}).style('fill','blue')
			.attr('height',(d)=>{return d.hierp;}).attr('width',25);
        product.append('text').style('text-anchor','middle')
            .attr('dx',(d,i)=>{return (i*dec+12);}).attr('dy',10).style('fill','black')
            .text(d=> {return d.hierp.toFixed(0) + '%'});
        product.append('text').style('text-anchor','start').attr('transform',(d,i)=>{return 'translate('+(i*dec+15)+',110)rotate(270)';})
 //           .attr('dx',(d,i)=>{return (i*45+12);}).attr('dy',90)
            .style('fill','white')
            .text((d,i)=> {return listeDashboard[i].unité;});
        product.append('circle')
            .attr('cx',(d,i)=>{return i*dec+30;}).attr('cy',(d)=>{return 120-d.nowp;}).style('fill','red')
            .attr('r',4);
*/
		//----------
		// nouvelle représentation
		
		const inter = Math.min((height-margin.top-margin.bottom)/6,(width-margin.left-margin.right)/12), marge=16, centre=marge+inter;
        const c = ['#1E90FF','#ff7f50'];
		let nDashG = graph.append('g')
			.attr('transform', 'translate(' + margin.left+ ',' + (margin.top) + ')') //epxxx enlever 500
			.attr('width', w).attr('height', 350);
		let article = nDashG.selectAll('g').data(data).enter().append('g')
			.attr('transform',(d,i)=>{return 'translate('+(d.c*(centre)*2.1)+','+(d.l*(centre)*2.5)+')'});
//		article.append('circle').attr('cx',100).attr('cy',100).attr('r',35).style('fill','white').style('stroke','blue').style('stroke-width',3);
//		article.append('line').attr('x1',100+30*Math.sin(Math.PI/4)).attr('y1',100-30*Math.cos(Math.PI/4)).attr('x2',100-30*Math.sin(Math.PI/4)).attr('y2',100+30*Math.cos(Math.PI/4)).style('stroke','red').style('stroke-width',3);
        article.append('rect').attr('width',2*(centre)).attr('height',28).attr('y',-28).style('fill','#87CEFA').style('opacity',0.7);
        article.append('rect').attr('y',0).attr('width',2*(centre)).attr('height',2*(centre)).style('stroke','#blue')
            .style('stroke-width',1).style('fill','#fffafa').style('opacity',1);
		article.append('text').text((d,i)=> {
                let ii = listeDashboard.filter(a=>{ return a.tag == d.nom;});
                return ii[0].unité;})
            .attr('dx',centre).attr('dy',-15) //1.8*inter)
            .style('text-anchor','middle').style('fill','blue');
        article.append('text').style('text-anchor','middle')
            .attr('dx',centre).attr('dy',-5) //inter*1.6)
            .style('fill','black')
            .text(d=> {return d.nowp.toFixed(0) + '% ['+d.hierp.toFixed(0)+']'});

        article.call(testAdd);
        let xScale = d3.scaleLinear()
            .domain([0,100.0])
            .range([0, inter]);
        let rScale = d3.scaleLinear()
            .domain([0,23])
            .range([0, Math.PI]);
        let lScale = d3.scaleLinear()
            .domain([0,30])
            .range([3/2*Math.PI, Math.PI/2]);

		let histoG = article.selectAll('g').data((d)=>d.mois).enter();
//			.attr('transform',(d,i)=>{return 'translate('+(i*inter*2)+','+0+')'});
//        histoG.attr('x1',(d,i)=>{return i;}).attr('y1',(d,i,a)=>{return xScale(d.value/100000);}).attr('x2',(d,i)=>{return i+1;}).attr('y2',0).style('stroke','blue').style('stroke-width',1);
        histoG.append('line').attr('x1',centre).attr('y1',centre)
        .attr('x2',(d,i,a)=>{return centre+xScale(d.value/a[0].__data__.div)*Math.cos(lScale(i));})
        .attr('y2',(d,i,a)=>{return centre-xScale(d.value/a[0].__data__.div)*Math.sin(lScale(i));})
        .style('stroke',c[0]).style('stroke-width',3);
        histoG.append('text')
            .attr('dx',(d,i,a)=>{return centre+(inter+marge/2)*Math.cos(lScale(i));})
            .attr('dy',(d,i,a)=>{return centre-(inter+marge/2)*Math.sin(lScale(i));})
            .style('fill',c[0]).style('text-anchor','middle').style('font-size',8).text((d,i)=>(i+1));
        histoG.append('circle').attr('r',1)
            .attr('cx',(d,i,a)=>{return centre+(inter)*Math.cos(lScale(i));})
            .attr('cy',(d,i,a)=>{return centre-(inter)*Math.sin(lScale(i));})
            .style('fill','#000');

        let histoD = article.selectAll('g').data((d)=>d.jour).enter();
        histoD.append('line').attr('x1',centre).attr('y1',centre)
            .attr('x2',(d,i,a)=>{return centre+xScale(d.value/a[0].__data__.div)*Math.cos(rScale(i)-Math.PI/2);})
            .attr('y2',(d,i,a)=>{return centre-xScale(d.value/a[0].__data__.div)*Math.sin(rScale(i)-Math.PI/2);})
            .style('stroke',c[1]).style('stroke-width',1);
        histoD.append('text')
            .attr('dx',(d,i,a)=>{return centre+(inter+marge/2)*Math.cos(rScale(i)-Math.PI/2);})
            .attr('dy',(d,i,a)=>{return centre-(inter+marge/2)*Math.sin(rScale(i)-Math.PI/2);})
            .style('fill',c[1]).style('text-anchor','middle').style('font-size',8).text((d,i)=>(i+1));
        histoD.append('circle').attr('r',1)
            .attr('cx',(d,i,a)=>{return centre+(inter)*Math.cos(rScale(i)-Math.PI/2);})
            .attr('cy',(d,i,a)=>{return centre-(inter)*Math.sin(rScale(i)-Math.PI/2);})
            .style('fill','#000');

        article.append('circle').attr('cx',centre).attr('cy',centre).attr('r',inter/6)
            .style('fill',(d)=>{return d.nowp>10.0?'#006400':'#ff4500';})
            .style('stroke','#556B2F').style('stroke-width',1).raise().style('opacity',1.0);


function testAdd(d) {
//    console.log(d);
	}
  }
}
//------------------------
// Gestion du menu principal
//
function selGraphique() {
    clearSVG();
    svg.on('.zoom', null);
	if (config.dataOK) {
        console.log(listeVal);
        dataCompute();
    }
    switch (selGraphe) {
          case 0:
            if (config.dataOK) {
                 //- les select ...
/*                d3.select("#value_select")
       .selectAll('option').remove();
    d3.select("#value_select")
       .selectAll('option')
       .data(AllData).enter()
       .append('option')
       .text(function (d,i) { return d.dataReference; })
       .attr('value',function (d,i) { return i; });*/
             graphe(selCourbe);   
            }
            break;
          case 1:
            if (config.dataOK) matrix();
            break;
          case 2:
            analyse();
            break;
          case 3:
            param();break;
          case 4:
            if (config.credOK && !config.tagOK) getAllTag();
            selection();break;
          case 5:
            if (config.credOK) {
                loadDashBoard();
            }
            break;
          case -1:
            cred();
			break;
          default:
            console.log('Désole !');
        }
    }
   </script>
</body>
</html>
